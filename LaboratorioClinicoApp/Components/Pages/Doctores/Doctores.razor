@page "/doctores"

@using LaboratorioClinicoApp.Services
@using LaboratorioClinicoApp.DTO
@inject DoctorService doctorService
@inject NavigationManager nav

<link rel="stylesheet" href="/css/Pacientes/pacientes.css" />

<div class="pacientes-container">

    <!-- HEADER -->
    <div class="top-bar">
        <h2>Doctores</h2>
        <button class="btn-crear" @onclick='() => nav.NavigateTo("/doctores/agregarDoctor")'>
            + Crear Doctor
        </button>
    </div>

    <!-- BUSCADOR -->
    <div class="buscador-container">
        <input placeholder="Buscar por nombre, especialidad o ID..."
               @bind="searchTerm" @bind:event="oninput" />
    </div>

    <!-- FILTROS -->
    <div class="filtros-container">
        @foreach (var f in Filtros)
        {
            <button class="filtro-btn @(FiltroActivo(f) ? "activo" : "")"
                    @onclick="() => CambiarFiltro(f)">
                @f
            </button>
        }
    </div>

    <!-- LISTA -->
    @if (cargando)
    {
        <p>Cargando doctores...</p>
    }
    else
    {
        @foreach (var d in DoctoresFiltrados)
        {
            var color = Colores[d.Id % Colores.Count];

            <div class="paciente-card" @onclick='() => AbrirDetalle(d.Id)'>

                <!-- FOTO / AVATAR -->
                <div class="avatar-container">
                    @if (!string.IsNullOrEmpty(d.FotoUrl))
                    {
                        <img src="@d.FotoUrl" class="avatar-img" />
                    }
                    else
                    {
                        <div class="avatar-fallback" style="background:@color">
                            @d.Nombre.Substring(0, 1).ToUpper()
                        </div>
                    }
                </div>

                <div class="paciente-info">
                    <h4>@d.Nombre @d.Apellido</h4>
                    <small>Especialidad: @d.Especialidad</small>
                </div>

                <span class="flecha">›</span>
            </div>
        }
    }
</div>

@code {

    private List<DoctorDTO> doctores = new();
    private string searchTerm = "";
    private string filtro = "Todos";
    private bool cargando = true;

    private List<string> Filtros = new()
    { "Todos", "Activo", "Inactivo" };

    // Colores igual que usuarios/pacientes
    List<string> Colores = new()
    {
        "#3f51b5","#009688","#9c27b0","#2196f3",
        "#ff9800","#e91e63","#4caf50","#795548"
    };

    protected override async Task OnInitializedAsync()
    {
        doctores = await doctorService.GetDoctors() ?? new();
        cargando = false;
        StateHasChanged();
    }

    bool FiltroActivo(string f) => filtro == f;

    void CambiarFiltro(string f)
    {
        filtro = f;
    }

    void AbrirDetalle(int id)
    {
        nav.NavigateTo($"/doctores/detalle/{id}");
    }

    IEnumerable<DoctorDTO> DoctoresFiltrados =>
        doctores.Where(d =>
            (filtro == "Todos" || d.Estado == filtro) &&
            (string.IsNullOrWhiteSpace(searchTerm)
            || $"{d.Nombre} {d.Apellido}".Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
            || d.Especialidad.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
            || d.Id.ToString().Contains(searchTerm))
        );
}
