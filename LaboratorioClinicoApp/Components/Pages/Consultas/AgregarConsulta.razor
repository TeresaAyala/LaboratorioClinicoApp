@page "/consultas/agregarConsulta"
@using LaboratorioClinicoApp.DTO
@using LaboratorioClinicoApp.Services
@inject ConsultaService consultaService
@inject PacienteService pacienteService
@inject DoctorService doctorService
@inject CitaService citaService
@inject NavigationManager navManager

<div class="container my-5">
    <div class="card shadow-lg border-0 p-4" style="background-color:#f9f9ff;">
        <h3 class="text-center mb-4 text-primary">
            <i class="bi bi-plus-circle"></i> Agregar Consulta
        </h3>

        @if (!string.IsNullOrEmpty(mensaje))
        {
            <div style="background-color:@(mensajeError ? "#ffdddd" : "#ddffdd");
                        padding:10px;
                        border-radius:8px;
                        border:1px solid @(mensajeError ? "red" : "green");
                        margin-bottom:15px;
                        text-align:center;">
                @mensaje
            </div>
        }

        <EditForm Model="@consulta" OnValidSubmit="ConfirmarGuardar">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger mb-3" />

            <!-- 🧩 PACIENTE -->
            <div class="mb-3">
                <label class="form-label fw-bold text-secondary">Paciente <span class="text-danger">*</span></label>
                <select class="form-select border-primary shadow-sm"
                        @bind="consulta.IdPaciente"
                        @bind:after="OnPacienteChange"
                        required>
                    <option value="">Seleccione un paciente</option>
                    @foreach (var p in pacientes)
                    {
                        <option value="@p.Id">@($"{p.Nombre} {p.Apellido}")</option>
                    }
                </select>
                <ValidationMessage For="@(() => consulta.IdPaciente)" class="text-danger" />
            </div>

            <!-- 🧩 DOCTOR -->
            <div class="mb-3">
                <label class="form-label fw-bold text-secondary">Doctor <span class="text-danger">*</span></label>
                <select class="form-select border-primary shadow-sm"
                        @bind="consulta.IdDoctor"
                        required>
                    <option value="">Seleccione un doctor</option>
                    @foreach (var d in doctores)
                    {
                        <option value="@d.Id">@($"{d.Nombre} {d.Apellido}")</option>
                    }
                </select>
                <ValidationMessage For="@(() => consulta.IdDoctor)" class="text-danger" />
            </div>

            <!-- 🧩 CITA -->
            <div class="mb-3">
                <label class="form-label fw-bold text-secondary">Cita vinculada <span class="text-danger">*</span></label>
                <select class="form-select border-primary shadow-sm"
                        @bind="consulta.IdCita"
                        required>
                    <option value="">Seleccione una cita</option>
                    @foreach (var c in citasFiltradas)
                    {
                        var diaSemana = c.FechaHora.ToString("ddd", new System.Globalization.CultureInfo("es-ES"));
                        <option value="@c.Id">@($"{char.ToUpper(diaSemana[0]) + diaSemana.Substring(1)}, {c.FechaHora:dd/MM/yyyy HH:mm}")</option>
                    }
                </select>
                <ValidationMessage For="@(() => consulta.IdCita)" class="text-danger" />
            </div>

            <!-- 🧩 MOTIVO -->
            <div class="mb-3">
                <label class="form-label fw-bold text-secondary">Motivo de consulta <span class="text-danger">*</span></label>
                <InputTextArea class="form-control border-primary shadow-sm" rows="3" @bind-Value="consulta.Motivo" required />
                <ValidationMessage For="@(() => consulta.Motivo)" class="text-danger" />
            </div>

            <!-- 🧩 DIAGNÓSTICO -->
            <div class="mb-3">
                <label class="form-label fw-bold text-secondary">Diagnóstico</label>
                <InputTextArea class="form-control border-primary shadow-sm" rows="3" @bind-Value="consulta.Diagnostico" />
            </div>

            <!-- 🧩 FECHA -->
            <div class="mb-3">
                <label class="form-label fw-bold text-secondary">Fecha de consulta <span class="text-danger">*</span></label>
                <InputDate class="form-control border-primary shadow-sm" @bind-Value="consulta.FechaConsulta" required />
                <ValidationMessage For="@(() => consulta.FechaConsulta)" class="text-danger" />
            </div>

            <!-- 🧩 ESTADO -->
            <div class="mb-3">
                <label class="form-label fw-bold text-secondary">Estado <span class="text-danger">*</span></label>
                <InputSelect class="form-select border-primary shadow-sm" @bind-Value="consulta.Estado">
                    <option value="Activa">Activa</option>
                    <option value="Finalizada">Finalizada</option>
                    <option value="Cancelada">Cancelada</option>
                </InputSelect>
                <ValidationMessage For="@(() => consulta.Estado)" class="text-danger" />
            </div>

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-success px-4 me-2">
                    <i class="bi bi-save"></i> Guardar Consulta
                </button>
                <button type="button" class="btn btn-secondary px-4" @onclick='()=>navManager.NavigateTo("/consultas")'>
                    <i class="bi bi-x-circle"></i> Volver
                </button>
            </div>
        </EditForm>

        @if (mostrarConfirmacion)
        {
            <div style="position:fixed;
                        top:0; left:0; right:0; bottom:0;
                        background-color:rgba(0,0,0,0.4);
                        display:flex;
                        justify-content:center;
                        align-items:center;">
                <div style="background:white; padding:25px; border-radius:10px; width:320px; text-align:center; box-shadow:0 0 15px rgba(0,0,0,0.2);">
                    <h5 class="text-primary mb-3">Confirmar acción</h5>
                    <p>¿Desea guardar esta consulta?</p>
                    <button class="btn btn-primary me-2" @onclick="GuardarConsulta">Aceptar</button>
                    <button class="btn btn-danger" @onclick="()=>mostrarConfirmacion=false">Cancelar</button>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private ConsultaDTO consulta = new();
    private List<PacienteDTO> pacientes = new();
    private List<DoctorDTO> doctores = new();
    private List<CitaDTO> citasFiltradas = new();
    private string? mensaje;
    private bool mensajeError;
    private bool mostrarConfirmacion;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            pacientes = await pacienteService.GetPacientes();
            doctores = await doctorService.GetDoctors();
        }
        catch (Exception ex)
        {
            mensaje = $"❌ Error al cargar datos: {ex.Message}";
            mensajeError = true;
        }
    }

    private async Task OnPacienteChange()
    {
        if (consulta?.IdPaciente > 0)
        {
            var citas = await citaService.GetCitas();
            citasFiltradas = citas
                .Where(c => c.IdPaciente == consulta.IdPaciente)
                .OrderByDescending(c => c.FechaHora)
                .Take(5)
                .ToList();

            consulta.IdCita = 0;
        }
    }

    private void ConfirmarGuardar()
    {
        if (consulta == null ||
            consulta.IdPaciente == 0 ||
            consulta.IdDoctor == 0 ||
            consulta.IdCita == 0 ||
            string.IsNullOrWhiteSpace(consulta.Motivo) ||
            consulta.FechaConsulta == default)
        {
            mensaje = "⚠️ Debe completar todos los campos obligatorios antes de guardar.";
            mensajeError = true;
            return;
        }

        mostrarConfirmacion = true;
    }

    private async Task GuardarConsulta()
    {
        mostrarConfirmacion = false;
        try
        {
            await consultaService.AddConsulta(consulta);
            mensaje = "✅ Consulta agregada correctamente.";
            mensajeError = false;
            await Task.Delay(2000);
            navManager.NavigateTo("/consultas");
        }
        catch (Exception ex)
        {
            mensaje = $"❌ Error al guardar: {ex.Message}";
            mensajeError = true;
        }
    }
}
