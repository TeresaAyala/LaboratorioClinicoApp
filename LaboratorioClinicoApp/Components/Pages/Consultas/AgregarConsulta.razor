@page "/consulta/agregar"
@using LaboratorioClinicoApp.DTO
@using LaboratorioClinicoApp.Services
@inject ConsultaService consultaService
@inject PacienteService pacienteService
@inject DoctorService doctorService
@inject CitaService citaService
@inject NavigationManager navManager

<link rel="stylesheet" href="/bootstrap/bootstrap.min.css" />
<link rel="stylesheet" href="/css/Consulta/agregarConsulta.css" />

<div class="popup-wrapper">
    <div class="popup-card shadow-lg">

        <h2 class="form-title">🩺 Agregar Consulta</h2>
        <p class="form-subtitle">Complete los campos para registrar la consulta médica</p>

        @if (!string.IsNullOrEmpty(mensaje))
        {
            <div class="alert-box @(mensajeError ? "alert-error" : "alert-success")">
                @mensaje
            </div>
        }

        <EditForm Model="@consulta" OnValidSubmit="ConfirmarGuardar">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="input-group-custom">
                <label>Paciente <span class="req">*</span></label>

                <input list="listaPacientes"
                       class="form-control input-beauty"
                       placeholder="Escriba o seleccione un paciente"
                       @bind="pacienteNombre"
                       @bind:after="ValidarPaciente" />

                <datalist id="listaPacientes">
                    @foreach (var p in pacientes)
                    {
                        <option value="@($"{p.Nombre} {p.Apellido}")"></option>
                    }
                </datalist>
            </div>

            <div class="input-group-custom">
                <label>Doctor <span class="req">*</span></label>

                <input list="listaDoctores"
                       class="form-control input-beauty"
                       placeholder="Escriba o seleccione un doctor"
                       @bind="doctorNombre"
                       @bind:after="ValidarDoctor" />

                <datalist id="listaDoctores">
                    @foreach (var d in doctores)
                    {
                        <option value="@($"{d.Nombre} {d.Apellido}")"></option>
                    }
                </datalist>
            </div>

            <div class="input-group-custom mt-3">
                <label>Motivo <span class="req">*</span></label>
                <textarea class="form-control input-beauty" rows="3"
                          @bind="consulta.Motivo" required></textarea>
            </div>

            <div class="fecha-horas-container">

                <div>
                    <label>Fecha de Consulta <span class="req">*</span></label>

                    <input type="date"
                           class="form-control input-beauty"
                           value="@fechaSeleccionada.ToString("yyyy-MM-dd")"
                           min="@DateTime.Today.ToString("yyyy-MM-dd")"
                           @onchange="OnFechaChange" />
                </div>

                <div class="hora-container">
                    <label>
                        Horas disponibles –
                        @fechaSeleccionada.ToString("dddd d 'de' MMMM", new System.Globalization.CultureInfo("es-ES"))
                    </label>

                    <div class="grid-horas">
                        @foreach (var h in horasDisponibles)
                        {
                            bool ocupado = horasOcupadas.Contains(h);

                            <button type="button"
                                    class="hora-btn @(consultaHora == h ? "hora-activa" : "")"
                                    disabled="@(ocupado)"
                                    @onclick="@(() => SeleccionarHora(h))">
                                @h
                            </button>
                        }
                    </div>
                </div>
            </div>

            <div class="btn-container">
                <button type="button" class="btn-secondary-custom"
                        @onclick="@(() => navManager.NavigateTo("/consulta"))">
                    Cancelar
                </button>

                <button type="submit" class="btn-primary-custom">
                    Guardar
                </button>
            </div>
        </EditForm>

        @if (mostrarConfirmacion)
        {
            <div class="modal-overlay">
                <div class="modal-box">
                    <h5>Confirmar acción</h5>
                    <p>¿Desea guardar esta consulta?</p>

                    <button class="btn-primary-custom me-2" @onclick="GuardarConsulta">Aceptar</button>
                    <button class="btn-secondary-custom" @onclick="() => mostrarConfirmacion = false">Cancelar</button>
                </div>
            </div>
        }

        @if (mostrarAdvertencia)
        {
            <div class="mensaje-flotante">@advertenciaTexto</div>
        }
    </div>
</div>


@code {

    private ConsultaDTO consulta = new() { Estado = "Activa" };

    private List<PacienteDTO> pacientes = new();
    private List<DoctorDTO> doctores = new();
    private List<CitaDTO> citasFiltradas = new();

    private string pacienteNombre = "";
    private string doctorNombre = "";

    private string? mensaje;
    private bool mensajeError;
    private bool mostrarConfirmacion;

    private DateTime fechaSeleccionada = DateTime.Today;
    private string consultaHora = "";

    private List<string> horasDisponibles = new();
    private List<string> horasOcupadas = new();

    private readonly List<(int Mes, int Dia)> feriados = new()
    {
        (1,1),(5,1),(9,15),(12,25)
    };

    private bool mostrarAdvertencia;
    private string advertenciaTexto = "";

    protected override async Task OnInitializedAsync()
    {
        pacientes = await pacienteService.GetPacientes();
        doctores = await doctorService.GetDoctors();

        // Inicializar horas para el día de hoy
        GenerarHoras();
    }

    private void ValidarPaciente()
    {
        var p = pacientes
            .FirstOrDefault(x => $"{x.Nombre} {x.Apellido}".Equals(pacienteNombre, StringComparison.OrdinalIgnoreCase));

        consulta.IdPaciente = p?.Id ?? 0;
    }

    private void ValidarDoctor()
    {
        var d = doctores
            .FirstOrDefault(x => $"{x.Nombre} {x.Apellido}".Equals(doctorNombre, StringComparison.OrdinalIgnoreCase));

        consulta.IdDoctor = d?.Id ?? 0;
    }

    private async Task OnFechaChange(ChangeEventArgs e)
    {
        consultaHora = ""; // Limpiar hora seleccionada al cambiar la fecha

        // Intentar parsear el valor. Si es nulo o inválido, reestablecer.
        if (e.Value == null || !DateTime.TryParse(e.Value.ToString(), out DateTime nuevaFecha))
        {
            fechaSeleccionada = DateTime.Today;
            GenerarHoras();
            StateHasChanged(); // Forzar actualización visual
            return;
        }

        fechaSeleccionada = nuevaFecha;

        // 1. Bloquear Domingos
        if (fechaSeleccionada.DayOfWeek == DayOfWeek.Sunday)
        {
            MostrarAdvertencia("❌ Los domingos no se atiende.");

            // Reestablecer a la fecha de hoy para limpiar el input visualmente
            fechaSeleccionada = DateTime.Today;
            GenerarHoras();
            StateHasChanged(); // CRUCIAL para que el input refleje la fecha de hoy
            return;
        }

        // 2. Bloquear Feriados
        if (EsFeriado(fechaSeleccionada))
        {
            MostrarAdvertencia("🎌 Ese día es feriado. No se atiende.");

            // Reestablecer a la fecha de hoy
            fechaSeleccionada = DateTime.Today;
            GenerarHoras();
            StateHasChanged(); // CRUCIAL para que el input refleje la fecha de hoy
            return;
        }

        // --- Cargar Horas Ocupadas (si la fecha es válida) ---
        var todas = await consultaService.GetConsultas();
        horasOcupadas = todas
            .Where(c => c.FechaConsulta.Date == fechaSeleccionada.Date)
            .Select(c => c.FechaConsulta.ToString("HH:mm"))
            .ToList();

        // Generar Horas Disponibles (aplica restricción del sábado)
        GenerarHoras();
    }

    private bool EsFeriado(DateTime f)
        => feriados.Any(x => x.Mes == f.Month && x.Dia == f.Day);

    private void GenerarHoras()
    {
        horasDisponibles.Clear();

        // LÓGICA CLAVE: Sábado vs. Otros días

        // Horario normal (Lunes a Viernes)
        if (fechaSeleccionada.DayOfWeek != DayOfWeek.Saturday)
        {
            horasDisponibles = new()
            {
                "07:00","07:30","08:00","08:30",
                "09:00","09:30","10:00","10:30",
                "11:00","11:30",
                "13:00","13:30","14:00","14:30",
                "15:00","15:30","16:00","16:30"
            };
        }
        // Horario de Sábado (solo mañana, excluye horas de la tarde)
        else
        {
            horasDisponibles = new()
            {
                "07:00","07:30","08:00","08:30",
                "09:00","09:30","10:00","10:30",
                "11:00","11:30"
            };
        }
    }

    private void SeleccionarHora(string h)
    {
        consultaHora = h;
        consulta.FechaConsulta = fechaSeleccionada.Add(TimeSpan.Parse(h));
    }

    private void ConfirmarGuardar()
    {
        if (consulta.IdPaciente == 0 ||
            consulta.IdDoctor == 0 ||
            string.IsNullOrEmpty(consultaHora))
        {
            mensaje = "⚠ Debe completar todos los campos obligatorios.";
            mensajeError = true;
            return;
        }

        mostrarConfirmacion = true;
    }

    private async Task GuardarConsulta()
    {
        mostrarConfirmacion = false;

        try
        {
            await consultaService.AddConsulta(consulta);

            mensaje = "✅ Consulta guardada exitosamente.";
            mensajeError = false;

            await Task.Delay(1200);
            navManager.NavigateTo("/consulta");
        }
        catch (Exception ex)
        {
            mensaje = $"❌ Error al guardar: {ex.Message}";
            mensajeError = true;
        }
    }

    private async void MostrarAdvertencia(string msg)
    {
        advertenciaTexto = msg;
        mostrarAdvertencia = true;
        await Task.Delay(1700);
        mostrarAdvertencia = false;
    }
}