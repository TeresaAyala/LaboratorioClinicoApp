@page "/consulta"
@using LaboratorioClinicoApp.DTO
@using LaboratorioClinicoApp.Services
@inject ConsultaService consultaService
@inject PacienteService pacienteService
@inject DoctorService doctorService
@inject NavigationManager navManager

<link rel="stylesheet" href="/bootstrap/bootstrap.min.css" />
<link rel="stylesheet" href="/css/Cita/cita.css" />

<div class="citas-container">

    <!-- ENCABEZADO STICKY -->
    <header class="encabezado-sticky shadow-sm">

        <!-- NAV SUPERIOR -->
        <div class="d-flex justify-content-between align-items-center mb-3">

            <button class="btn btn-outline-primary" @onclick="Hoy">
                <i class="bi bi-calendar-event"></i> Hoy
            </button>

            <div class="text-center flex-grow-1">
                <div class="btn-group">
                    <button class="btn btn-outline-secondary @(vistaDia ? "active" : "")"
                            @onclick="() => CambiarVista(VistaType.Dia)">
                        Día
                    </button>

                    <button class="btn btn-outline-secondary @(vistaSemana ? "active" : "")"
                            @onclick="() => CambiarVista(VistaType.Semana)">
                        Semana
                    </button>

                    <button class="btn btn-outline-secondary @(vistaMes ? "active" : "")"
                            @onclick="() => CambiarVista(VistaType.Mes)">
                        Mes
                    </button>
                </div>

                <div class="mt-2 fw-bold fs-5">
                    @FechaActual.ToString("dddd, dd 'de' MMMM yyyy")
                </div>

                <div class="mt-1">
                    <button class="btn btn-sm btn-light me-2" @onclick="DiaAnterior">◀</button>
                    <button class="btn btn-sm btn-light" @onclick="DiaSiguiente">▶</button>
                </div>
            </div>

            <button class="btn btn-outline-dark">
                <i class="bi bi-person-circle"></i>
            </button>
        </div>

        <!-- TABS -->
        <div class="tab-menu">
            <div class="tab-item @(EsConsultas ? "active" : "")"
                 @onclick="@(() => navManager.NavigateTo("/citas"))">
                Citas de Exámenes
            </div>

            <div class="tab-item @(EsExamenes ? "active" : "")"
                 @onclick="@(() => navManager.NavigateTo("/consulta"))">
                Consultas Médicas
            </div>
        </div>

        <!-- FILTROS -->
        <div class="card shadow-sm p-3 filtros-card">
            <div class="row g-3 align-items-end">

                <!-- PACIENTE -->
                <div class="col-12 col-md-4">
                    <label class="form-label">Paciente</label>
                    <input list="listaPacientes"
                           class="form-control"
                           placeholder="Buscar paciente..."
                           @bind="FiltroPaciente"
                           @bind:event="oninput" />

                    <datalist id="listaPacientes">
                        @foreach (var p in pacientes)
                        {
                            <option value="@($"{p.Nombre} {p.Apellido}")"></option>
                        }
                    </datalist>
                </div>

                <!-- DOCTOR -->
                <div class="col-12 col-md-4">
                    <label class="form-label">Doctor</label>
                    <input list="listaDoctores"
                           class="form-control"
                           placeholder="Buscar doctor..."
                           @bind="FiltroDoctor"
                           @bind:event="oninput" />

                    <datalist id="listaDoctores">
                        @foreach (var d in doctores)
                        {
                            <option value="@($"{d.Nombre} {d.Apellido}")"></option>
                        }
                    </datalist>
                </div>

                <!-- FECHA -->
                <div class="col-6 col-md-2">
                    <label class="form-label">Fecha</label>
                    <input type="date" class="form-control" @onchange="OnFechaChange" />
                </div>

                <!-- NUEVA -->
                <div class="col-6 col-md-2 d-flex align-items-end">
                    <button class="btn btn-success w-100" @onclick="NuevaConsulta">
                        <i class="bi bi-plus-lg"></i> Nueva
                    </button>
                </div>

            </div>
        </div>

    </header>

    <!-- LISTA -->
    <main class="contenido-scroll">

        @if (consultasFiltradas.Count == 0)
        {
            <div class="alert alert-info text-center mt-4">No hay consultas con estos filtros.</div>
        }
        else
        {
            @foreach (var item in consultasFiltradas)
            {
                <div class="agenda-item shadow-sm" @onclick="() => EditarConsulta(item.Id)">

                    <div class="agenda-hora text-primary fw-bold">
                        @item.FechaConsulta.ToString("HH:mm")
                        <div class="text-muted small">@item.FechaConsulta.ToString("dd/MM/yyyy")</div>
                    </div>

                    <div class="agenda-info">
                        <div class="fw-bold fs-6">@item.Motivo</div>

                        <div class="text-muted small">
                            <strong>Paciente:</strong> @GetPacienteNombre(item.IdPaciente)
                        </div>

                        <div class="text-muted small">
                            <strong>Doctor:</strong> @GetDoctorNombre(item.IdDoctor)
                        </div>
                    </div>

                    <div class="estado-badge">
                        <span class="badge bg-success bg-opacity-25 text-success px-3 py-2 rounded-pill">
                            Activo
                        </span>
                    </div>

                    <div>
                        <button class="btn btn-outline-primary btn-sm"
                                @onclick="@(() => EditarConsulta(item.Id))">
                            Editar
                        </button>
                    </div>

                </div>
            }
        }

    </main>
</div>

@code {

    List<ConsultaDTO> consultas = new();
    List<ConsultaDTO> consultasFiltradas = new();
    List<PacienteDTO> pacientes = new();
    List<DoctorDTO> doctores = new();

    string FiltroPaciente = "";
    string FiltroDoctor = "";
    string FechaFiltroString = "";

    DateTime FechaActual = DateTime.Today;

    private bool EsConsultas => navManager.Uri.Contains("/citas");
    private bool EsExamenes => navManager.Uri.Contains("/consulta") &&
                               !navManager.Uri.Contains("/consulta/editar") &&
                               !navManager.Uri.Contains("/consulta/agregar");

    bool vistaDia = true, vistaSemana = false, vistaMes = false;

    enum VistaType { Dia, Semana, Mes }

    protected override async Task OnInitializedAsync()
    {
        pacientes = await pacienteService.GetPacientes();
        doctores = await doctorService.GetDoctors();
        consultas = await consultaService.GetConsultas();

        AplicarFiltros();
    }

    string GetPacienteNombre(int id) =>
        pacientes.FirstOrDefault(x => x.Id == id) is { } p
            ? $"{p.Nombre} {p.Apellido}"
            : "Desconocido";

    string GetDoctorNombre(int id) =>
        doctores.FirstOrDefault(x => x.Id == id) is { } d
            ? $"{d.Nombre} {d.Apellido}"
            : "Desconocido";

    void AplicarFiltros()
    {
        var q = consultas.Where(c => c.FechaConsulta.Date == FechaActual.Date);

        if (!string.IsNullOrWhiteSpace(FiltroPaciente))
            q = q.Where(c => GetPacienteNombre(c.IdPaciente)
            .ToLower().Contains(FiltroPaciente.ToLower()));

        if (!string.IsNullOrWhiteSpace(FiltroDoctor))
            q = q.Where(c => GetDoctorNombre(c.IdDoctor)
            .ToLower().Contains(FiltroDoctor.ToLower()));

        consultasFiltradas = q.ToList();
    }

    void OnFechaChange(ChangeEventArgs e)
    {
        FechaFiltroString = e.Value?.ToString() ?? "";
        if (DateTime.TryParse(FechaFiltroString, out var f))
            FechaActual = f;

        AplicarFiltros();
    }

    void CambiarVista(VistaType vista)
    {
        vistaDia = vista == VistaType.Dia;
        vistaSemana = vista == VistaType.Semana;
        vistaMes = vista == VistaType.Mes;

        AplicarFiltros();
        StateHasChanged();
    }

    void Hoy() { FechaActual = DateTime.Today; AplicarFiltros(); }
    void DiaAnterior() { FechaActual = FechaActual.AddDays(-1); AplicarFiltros(); }
    void DiaSiguiente() { FechaActual = FechaActual.AddDays(1); AplicarFiltros(); }

    void NuevaConsulta() => navManager.NavigateTo("/consulta/agregar");
    void EditarConsulta(int id) => navManager.NavigateTo($"/consulta/editar/{id}");
}