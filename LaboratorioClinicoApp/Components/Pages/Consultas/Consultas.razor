@page "/consultas"
@using LaboratorioClinicoApp.Services
@using LaboratorioClinicoApp.DTO
@inject ConsultaService consultaService
@inject PacienteService pacienteService
@inject DoctorService doctorService
@inject CitaService citaService
@inject NavigationManager navManager

<link rel="stylesheet" href="css/Examenes/examenes.css" />

<div class="container my-5">
    <div class="card shadow-lg border-0">
        <div class="card-header bg-primary text-white text-center">
            <h3 class="mb-0">
                <i class="bi bi-journal-medical"></i> Lista de Consultas
            </h3>
        </div>

        <div class="card-body">

            <!-- 🔹 Barra superior -->
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">

                <button class="btn btn-success"
                        @onclick='() => navManager.NavigateTo("/consultas/agregarConsulta")'>
                    <i class="bi bi-plus-circle me-1"></i> Agregar consulta
                </button>

                <div class="input-group" style="max-width: 300px;">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" placeholder="Buscar consulta..."
                           @bind="searchText" @bind:event="oninput" />
                </div>

            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger text-center">@errorMessage</div>
            }

            <!-- ESTADOS -->
            <div class="d-flex gap-2 flex-wrap mb-4">
                <button class='btn @(estadoSeleccionado == "Todos" ? "btn-primary" : "btn-outline-primary")'
                        @onclick='() => SeleccionarEstado("Todos")'>
                    Todos
                </button>

                @foreach (var estado in EstadosUnicos)
                {
                    <button class='btn @(estadoSeleccionado == estado ? "btn-primary" : "btn-outline-primary")'
                            @onclick='() => SeleccionarEstado(estado)'>
                        @estado
                    </button>
                }
            </div>

            <!-- LISTA -->
            @if (consultas == null)
            {
                <div class="text-center my-4">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-3">Cargando consultas...</p>
                </div>
            }
            else if (!consultas.Any())
            {
                <div class="alert alert-warning text-center">
                    <i class="bi bi-exclamation-circle"></i> No hay consultas registradas.
                </div>
            }
            else
            {
                <div class="row g-3">
                    @foreach (var consulta in FiltradasPorEstado)
                    {
                        <div class="col-12 col-md-6 col-lg-4">
                            <div class="exam-card exam-click shadow-sm"
                                 @onclick='() => navManager.NavigateTo($"/consultas/detalle/{consulta.Id}")'>

                                <!-- Título -->
                                <div class="exam-title">
                                    <i class="bi bi-stethoscope"></i>
                                    <strong>@consulta.Motivo</strong>
                                </div>

                                <!-- Información -->
                                <div class="info-box">
                                    <span class="label">Paciente:</span>
                                    <span class="value">@ObtenerNombrePaciente(consulta.IdPaciente)</span>
                                </div>

                                <div class="info-box">
                                    <span class="label">Doctor:</span>
                                    <span class="value">@ObtenerNombreDoctor(consulta.IdDoctor)</span>
                                </div>

                                <div class="info-box">
                                    <span class="label">Fecha de consulta:</span>
                                    <span class="value">@consulta.FechaConsulta.ToString("dd/MM/yyyy HH:mm")</span>
                                </div>

                                <div class="info-box">
                                    <span class="label">Cita:</span>
                                    <span class="value">
                                        @citas.FirstOrDefault(c => c.Id == consulta.IdCita)?.FechaHora.ToString("dd/MM/yyyy HH:mm")
                                    </span>
                                </div>

                                <!-- ESTADO + EDITAR -->
                                <div class="d-flex justify-content-between align-items-center mt-3">

                                    <span class="badge px-3 py-2 text-white @ClaseEstado(consulta.Estado)">
                                        @consulta.Estado
                                    </span>

                                    <button class="btn btn-outline-primary btn-sm"
                                            @onclick:stopPropagation="true"
                                            @onclick="() => EditarConsulta(consulta.Id)">
                                        <i class="bi bi-pencil-square"></i> Editar
                                    </button>

                                </div>

                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

@code {
    private List<ConsultaDTO>? consultas = null;
    private List<PacienteDTO> pacientes = new();
    private List<DoctorDTO> doctores = new();
    private List<CitaDTO> citas = new();

    private string searchText = "";
    private string? errorMessage = null;
    private string estadoSeleccionado = "Todos";

    protected override async Task OnInitializedAsync()
    {
        await LoadConsultas();
    }

    private async Task LoadConsultas()
    {
        try
        {
            consultas = await consultaService.GetConsultas();
            pacientes = await pacienteService.GetPacientes();
            doctores = await doctorService.GetDoctors();
            citas = await citaService.GetCitas();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cargar consultas: {ex.Message}";
        }
    }

    private IEnumerable<ConsultaDTO> Filtrados =>
        string.IsNullOrWhiteSpace(searchText)
            ? consultas
            : consultas.Where(c =>
                ObtenerNombrePaciente(c.IdPaciente)
                    .Contains(searchText, StringComparison.OrdinalIgnoreCase)
            );

    private string ObtenerNombrePaciente(int idPaciente)
    {
        var p = pacientes.FirstOrDefault(p => p.Id == idPaciente);
        return p == null ? "" : $"{p.Nombre} {p.Apellido}".Trim();
    }

    private string ObtenerNombreDoctor(int idDoctor)
    {
        var d = doctores.FirstOrDefault(d => d.Id == idDoctor);
        return d == null ? "" : $"{d.Nombre} {d.Apellido}".Trim();
    }

    private List<String> EstadosUnicos =>
        consultas?
            .Select(c => c.Estado)
            .Where(e => !string.IsNullOrWhiteSpace(e))
            .Distinct()
            .OrderBy(e => e)
            .ToList()
        ?? new List<string>();

    private IEnumerable<ConsultaDTO> FiltradasPorEstado =>
        estadoSeleccionado == "Todos"
            ? Filtrados
            : Filtrados.Where(c => c.Estado == estadoSeleccionado);

    private void SeleccionarEstado(string estado)
    {
        estadoSeleccionado = estado;
    }

    private void EditarConsulta(int id)
    {
        navManager.NavigateTo($"/consultas/editarConsulta/{id}");
    }

    private string ClaseEstado(string estado)
    {
        return estado switch
        {
            "Activa" => "bg-primary",
            "Finalizada" => "bg-success",
            "Cancelada" => "bg-danger",
            "Inactiva" => "bg-secondary",
            _ => "bg-dark"
        };
    }
}
