@page "/consulta"
@using LaboratorioClinicoApp.Services
@using LaboratorioClinicoApp.DTO
@inject CitaService citaService
@inject PacienteService pacienteService
@inject DoctorService doctorService
@inject NavigationManager navManager

<link href="/css/Cita/cita.css" rel="stylesheet" />

<div class="agenda-header">
    <button class="icon-btn" title="Ir a hoy" @onclick="IrHoy">📅</button>

    <div class="agenda-center">
        <div class="agenda-title">Agenda</div>

        <div class="agenda-tabs" role="tablist" aria-label="Vistas">
            <button class="tab @(vistaDia ? "active" : "")" @onclick="() => CambiarVista(VistaType.Dia)">Día</button>
            <button class="tab @(vistaSemana ? "active" : "")" @onclick="() => CambiarVista(VistaType.Semana)">Semana</button>
            <button class="tab @(vistaMes ? "active" : "")" @onclick="() => CambiarVista(VistaType.Mes)">Mes</button>
        </div>

        <div class="agenda-date">
            <button class="small-nav" @onclick="DiaAnterior" title="Anterior">◀</button>
            <div class="today-label">@fechaSeleccionada.ToString("dddd, dd 'de' MMMM 'de' yyyy")</div>
            <button class="small-nav" @onclick="DiaSiguiente" title="Siguiente">▶</button>
        </div>
    </div>

    <button class="icon-btn" title="Perfil">👤</button>
</div>

<!-- TABS SUPERIORES: Navegación entre Consulta y Exámenes -->
<div class="top-tabs">
    <button class="top-tab"
            @onclick='() => navManager.NavigateTo("/citas")'>
        Consulta Médica
    </button>

    <button class="top-tab active"
            @onclick='() => navManager.NavigateTo("/consulta")'>
        Citas de Exámenes
    </button>
</div>

<!-- FILTROS -->
<div class="filtros">
    <div class="filtro-item">
        <label>Doctor</label>
        <select class="form-select" @onchange="OnFilterDoctorChange">
            <option value="">Todos los doctores</option>
            @foreach (var d in doctores)
            {
                <option value="@d.Id">@($"{d.Nombre} {d.Apellido}")</option>
            }
        </select>
    </div>

    <div class="filtro-item">
        <label>Mes</label>
        <select class="form-select" @onchange="OnFilterMesChange">
            <option value="">Todos</option>
            @for (int m = 1; m <= 12; m++)
            {
                <option value="@m">@((new DateTime(2000, m, 1)).ToString("MMMM"))</option>
            }
        </select>
    </div>

    <div class="filtro-item">
        <label>Fecha</label>
        <input type="date" class="form-control" @onchange="OnFilterFechaChange" />
    </div>

    <div class="filtro-item">
        <label>Paciente</label>
        <select class="form-select" @onchange="OnFilterPacienteChange">
            <option value="">Todos los pacientes</option>
            @foreach (var p in pacientes)
            {
                <option value="@p.Id">@($"{p.Nombre} {p.Apellido}")</option>
            }
        </select>
    </div>

    <div class="filtro-item">
        <label>Estado</label>
        <select class="form-select" @onchange="OnFilterEstadoChange">
            <option value="">Todos</option>
            <option value="Confirmada">Confirmada</option>
            <option value="Pendiente">Pendiente</option>
            <option value="Activo">Activo</option>
        </select>
    </div>

    <div class="filtro-actions">
        <button class="btn btn-primary btn-sm" @onclick="NuevaCita">＋ Nueva</button>
    </div>
</div>

<!-- CONTENIDO -->
<div class="page-container">
    <div class="content">
        @if (isLoading)
        {
            <div class="loading">Cargando citas...</div>
        }
        else if (citasFiltradas.Count == 0)
        {
            <p class="sin-citas">No hay citas para esta fecha.</p>
        }
        else
        {
            @foreach (var cita in citasFiltradas)
            {
                var paciente = pacientes.FirstOrDefault(p => p.Id == cita.IdPaciente);
                var doctor = doctores.FirstOrDefault(d => d.Id == cita.IdDoctor);

                <div class="cita-card">
                    <div class="cita-hora">
                        <span class="hora-num">@cita.FechaHora.ToString("hh:mm")</span>
                        <span class="hora-ampm">@cita.FechaHora.ToString("tt")</span>
                    </div>

                    <div class="cita-info">
                        <div class="motivo">@cita.Motivo</div>

                        <div class="meta-line">
                            <strong>Fecha:</strong> @cita.FechaHora.ToString("dd 'de' MMMM 'de' yyyy")
                        </div>

                        <div class="meta-line">
                            <strong>Paciente:</strong> @(pacientes.Any()
                                                ? GetNombrePaciente(cita.IdPaciente)
                                                : "Cargando...")
                                                            </div>

                        <div class="meta-line">
                            <strong>Doctor:</strong>
                            @(doctor != null
                                                ? $"{doctor.Nombre} {doctor.Apellido}"
                                                : (cita.IdDoctor.HasValue ? $"ID {cita.IdDoctor}" : "—"))
                </div>

                @if (!string.IsNullOrWhiteSpace(cita.NotasConsulta))
                        {
                            <p class="info-notas"><strong>Notas:</strong> @cita.NotasConsulta</p>
                        }

                        <div class="status-row">
                            @if (cita.Estado == "Confirmada")
                            {
                                <span class="badge badge-confirmed">Confirmada</span>
                            }
                            else
                            {
                                <span class="badge badge-pending">Pendiente</span>
                            }
                        </div>
                    </div>

                    <div class="cita-actions">
                        <button class="btn-edit" @onclick='() => navManager.NavigateTo($"/citas/editar/{cita.Id}")'>
                            Editar
                        </button>
                    </div>
                </div>
            }
        }
    </div>
</div>

@code {
    private List<CitaDTO> citas = new();
    private List<CitaDTO> citasFiltradas = new();
    private List<PacienteDTO> pacientes = new();
    private List<DoctorDTO> doctores = new();

    private DateTime fechaSeleccionada = DateTime.Today;
    private bool vistaDia = true;
    private bool vistaSemana = false;
    private bool vistaMes = false;

    private int? filtroDoctor = null;
    private int? filtroPaciente = null;
    private string? filtroEstado = null;
    private int? filtroMes = null;

    private bool isLoading = true;

    enum VistaType { Dia, Semana, Mes }

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;

        citas = await citaService.GetCitas();
        pacientes = await pacienteService.GetPacientes();
        doctores = await doctorService.GetDoctors();

        FiltrarCitas();
        isLoading = false;
    }

    private void FiltrarCitas()
    {
        var query = citas.AsQueryable();

        if (vistaDia)
        {
            query = query.Where(c => c.FechaHora.Date == fechaSeleccionada.Date);
        }
        else if (vistaSemana)
        {
            var day = (int)fechaSeleccionada.DayOfWeek;
            var startOfWeek = fechaSeleccionada.Date.AddDays(-(day == 0 ? 6 : day - 1));
            var endOfWeek = startOfWeek.AddDays(7).AddTicks(-1);
            query = query.Where(c => c.FechaHora >= startOfWeek && c.FechaHora <= endOfWeek);
        }
        else if (vistaMes)
        {
            query = query.Where(c => c.FechaHora.Month == fechaSeleccionada.Month
                                     && c.FechaHora.Year == fechaSeleccionada.Year);
        }

        if (filtroDoctor.HasValue)
            query = query.Where(c => c.IdDoctor == filtroDoctor.Value);

        if (filtroPaciente.HasValue)
            query = query.Where(c => c.IdPaciente == filtroPaciente.Value);

        if (!string.IsNullOrEmpty(filtroEstado))
            query = query.Where(c => c.Estado == filtroEstado);

        if (filtroMes.HasValue)
            query = query.Where(c => c.FechaHora.Month == filtroMes.Value);

        citasFiltradas = query.OrderBy(c => c.FechaHora).ToList();
        StateHasChanged();
    }

    private void DiaAnterior() { fechaSeleccionada = fechaSeleccionada.AddDays(-1); FiltrarCitas(); }
    private void DiaSiguiente() { fechaSeleccionada = fechaSeleccionada.AddDays(1); FiltrarCitas(); }

    private void CambiarVista(VistaType tipo)
    {
        vistaDia = tipo == VistaType.Dia;
        vistaSemana = tipo == VistaType.Semana;
        vistaMes = tipo == VistaType.Mes;
        // Si selecciona mes, mantén la fecha en el primer día del mes seleccionado
        if (vistaMes) fechaSeleccionada = new DateTime(fechaSeleccionada.Year, fechaSeleccionada.Month, 1);
        FiltrarCitas();
    }

    private void IrHoy()
    {
        fechaSeleccionada = DateTime.Today;
        FiltrarCitas();
    }

    private void NuevaCita() => navManager.NavigateTo("/citas/agregar");

    private void OnFilterDoctorChange(ChangeEventArgs e)
    {
        if (int.TryParse(e?.Value?.ToString(), out int id)) filtroDoctor = id; else filtroDoctor = null;
        FiltrarCitas();
    }

    private void OnFilterPacienteChange(ChangeEventArgs e)
    {
        if (int.TryParse(e?.Value?.ToString(), out int id)) filtroPaciente = id; else filtroPaciente = null;
        FiltrarCitas();
    }

    private void OnFilterEstadoChange(ChangeEventArgs e)
    {
        var s = e?.Value?.ToString();
        filtroEstado = string.IsNullOrEmpty(s) ? null : s;
        FiltrarCitas();
    }

    private void OnFilterMesChange(ChangeEventArgs e)
    {
        if (int.TryParse(e?.Value?.ToString(), out int mes)) filtroMes = mes; else filtroMes = null;
        FiltrarCitas();
    }

    private void OnFilterFechaChange(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e?.Value?.ToString(), out DateTime fecha))
        {
            fechaSeleccionada = fecha;
            vistaDia = true;
            vistaSemana = false;
            vistaMes = false;
        }
        FiltrarCitas();
    }

    private string GetNombrePaciente(int idPaciente)
    {
        var p = pacientes.FirstOrDefault(x => x.Id == idPaciente);
        return p != null ? $"{p.Nombre} {p.Apellido}" : $"ID {idPaciente}";
    }
}
