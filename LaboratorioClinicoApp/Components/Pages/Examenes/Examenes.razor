@page "/examenes"

@using LaboratorioClinicoApp.Services
@using LaboratorioClinicoApp.DTO

@inject ExamenService examenService
@inject PacienteService pacienteService
@inject NavigationManager nav

<link rel="stylesheet" href="css/Examenes/examenes.css" />

<div class="container my-5">
    <div class="card shadow-lg border-0">

        <div class="card-header bg-primary text-white text-center">
            <h3 class="mb-0">
                <i class="bi bi-clipboard2-pulse"></i> Exámenes
            </h3>
        </div>

        <div class="card-body">

            <!-- Barra superior -->
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">

                <button class="btn btn-success"
                        @onclick='() => nav.NavigateTo("/examenes/agregarExamen")'>
                    <i class="bi bi-plus-circle me-1"></i> Nuevo Examen
                </button>

                <div class="input-group" style="max-width: 300px;">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control"
                           placeholder="Buscar por paciente o tipo..."
                           @oninput="Filtrar" />
                </div>
            </div>

            <!-- Filtros por estado -->
            <div class="d-flex gap-2 flex-wrap mb-4">
                <button class='btn @(estadoSeleccionado == "Todos" ? "btn-primary" : "btn-outline-primary")'
                        @onclick='() => SeleccionarEstado("Todos")'>
                    Todos
                </button>

                @foreach (var est in EstadosUnicos)
                {
                    <button class='btn @(estadoSeleccionado == est ? "btn-primary" : "btn-outline-primary")'
                            @onclick='() => SeleccionarEstado(est)'>
                        @est
                    </button>
                }
            </div>

            <!-- Lista de tarjetas -->
            <div class="row g-3">
                @foreach (var e in ExamenesFinales)
                {
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="exam-card exam-click shadow-sm"
                             @onclick='() => nav.NavigateTo($"/examenes/detalle/{e.Id}")'>

                            <div class="exam-title">
                                <i class="bi bi-clipboard2-check"></i>
                                <strong>@e.TipoExamen</strong>
                            </div>

                            <p class="text-muted small">@e.Descripcion</p>

                            <div class="info-box">
                                <span class="label">Paciente:</span>
                                <span class="value">@NombrePaciente(e)</span>
                            </div>

                            <div class="info-box">
                                <span class="label">Fecha:</span>
                                <span class="value">@e.Fecha.ToString("dd/MM/yyyy HH:mm")</span>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <span class="badge px-3 py-2 text-white @ClaseEstado(e.Estado)">
                                    @e.Estado
                                </span>

                                <button class="btn btn-outline-primary btn-sm"
                                        @onclick:stopPropagation="true"
                                        @onclick="() => EditarExamen(e.Id)">
                                    <i class="bi bi-pencil-square"></i> Editar
                                </button>
                            </div>

                        </div>
                    </div>
                }
            </div>

        </div>
    </div>
</div>

@code {

    List<ExamenDTO> examenes = new();
    List<ExamenDTO> examenesFiltrados = new();
    List<PacienteDTO> pacientes = new();

    private string textoFiltro = "";
    private string estadoSeleccionado = "Todos";

    protected override async Task OnInitializedAsync()
    {
        await Load();
        AplicarFiltros();
    }

    private async Task Load()
    {
        examenes = await examenService.GetExamenes();
        pacientes = await pacienteService.GetPacientes();

        // Matching paciente
        foreach (var e in examenes)
        {
            if (e.Paciente == null && e.IdPaciente > 0)
            {
                e.Paciente = pacientes.FirstOrDefault(p => p.Id == e.IdPaciente);
            }
        }

        examenesFiltrados = examenes.ToList();
    }

    private void Filtrar(ChangeEventArgs e)
    {
        textoFiltro = e.Value?.ToString()?.ToLower() ?? "";
        AplicarFiltros();
    }

    private void SeleccionarEstado(string estado)
    {
        estadoSeleccionado = estado;
        AplicarFiltros();
    }

    private void AplicarFiltros()
    {
        examenesFiltrados = examenes.Where(e =>
            (e.Paciente != null &&
                $"{e.Paciente.Nombre} {e.Paciente.Apellido}".ToLower().Contains(textoFiltro))
            ||
            e.TipoExamen.ToLower().Contains(textoFiltro)
        ).ToList();
    }

    private IEnumerable<ExamenDTO> ExamenesFinales =>
        estadoSeleccionado == "Todos"
            ? examenesFiltrados
            : examenesFiltrados.Where(e => e.Estado == estadoSeleccionado);

    private List<string> EstadosUnicos =>
        examenes
            .Select(e => e.Estado)
            .Distinct()
            .OrderBy(e => e)
            .ToList();

    private string NombrePaciente(ExamenDTO e)
    {
        if (e.Paciente != null)
            return $"{e.Paciente.Nombre} {e.Paciente.Apellido}";

        // fallback si API solo envía PacienteNombre
        return e.PacienteNombre ?? "Sin datos";
    }

    private string ClaseEstado(string estado) => estado switch
    {
        "Pendiente" => "bg-secondary",
        "Completado" => "bg-success",
        "Cancelado" => "bg-danger",
        _ => "bg-dark"
    };

    private void EditarExamen(int id)
    {
        nav.NavigateTo($"/examenes/editarExamen/{id}");
    }
}
