@page "/examenes"

@using LaboratorioClinicoApp.Services
@using LaboratorioClinicoApp.DTO

@inject ResultadoService resultadoService
@inject ExamenService examenService
@inject DoctorService doctorService
@inject PacienteService pacienteService
@inject NavigationManager nav

<link rel="stylesheet" href="css/Resultados/resultados.css" />

<div class="container my-5">
    <div class="card shadow-lg border-0">

        <div class="card-header bg-primary text-white text-center">
            <h3 class="mb-0">
                <i class="bi bi-clipboard2-pulse"></i> Resultados de Exámenes
            </h3>
        </div>

        <div class="card-body">

            <!-- 🔹 Barra superior -->
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">

                <button class="btn btn-success"
                        @onclick='() => nav.NavigateTo("/resultados/agregarResultado")'>
                    <i class="bi bi-plus-circle me-1"></i> Nuevo Resultado
                </button>

                <div class="input-group" style="max-width: 300px;">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control"
                           placeholder="Buscar por paciente o examen..."
                           @oninput="Filtrar" />
                </div>
            </div>

            <!-- 🔹 Filtros por ESTADO -->
            <div class="d-flex gap-2 flex-wrap mb-4">
                <button class='btn @(estadoSeleccionado == "Todos" ? "btn-primary" : "btn-outline-primary")'
                        @onclick='() => SeleccionarEstado("Todos")'>
                    Todos
                </button>

                @foreach (var estado in EstadosUnicos)
                {
                    <button class='btn @(estadoSeleccionado == estado ? "btn-primary" : "btn-outline-primary")'
                            @onclick='() => SeleccionarEstado(estado)'>
                        @estado
                    </button>
                }
            </div>

            <!-- 🔹 LISTA DE RESULTADOS COMO CARDS -->
            <div class="row g-3">
                @foreach (var r in ResultadosFiltradosEstado)
                {
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="exam-card exam-click shadow-sm"
                             @onclick='() => nav.NavigateTo($"/resultados/detalle/{r.Id}")'>

                            <!-- Título -->
                            <div class="exam-title">
                                <i class="bi bi-clipboard2-check"></i>
                                <strong>@r.Examen?.TipoExamen</strong>
                            </div>

                            <p class="text-muted small">@r.Detalle</p>

                            <!-- Info -->
                            <div class="info-box">
                                <span class="label">Paciente:</span>
                                <span class="value">
                                    @(r.Paciente == null
                                        ? "Sin datos"
                                        : $"{r.Paciente.Nombre} {r.Paciente.Apellido}")
                                </span>
                            </div>

                            <div class="info-box">
                                <span class="label">Doctor:</span>
                                <span class="value">@($"{r.Doctor?.Nombre} {r.Doctor?.Apellido}")</span>
                            </div>

                            <div class="info-box">
                                <span class="label">Fecha emisión:</span>
                                <span class="value">@r.FechaEmision.ToString("dd/MM/yyyy HH:mm")</span>
                            </div>

                            <!-- ESTADO + BOTÓN EDITAR -->
                            <div class="d-flex justify-content-between align-items-center mt-3">

                                <span class="badge px-3 py-2 text-white @ClaseEstado(r.Estado)">
                                    @r.Estado
                                </span>

                                <button class="btn btn-outline-primary btn-sm"
                                        @onclick:stopPropagation="true"
                                        @onclick="() => EditarResultado(r.Id)">
                                    <i class="bi bi-pencil-square"></i> Editar
                                </button>

                            </div>

                        </div>
                    </div>
                }
            </div>

        </div>
    </div>
</div>

@code {

    List<ResultadoDTO> resultados = new();
    List<ResultadoDTO> resultadosFiltrados = new();

    List<ExamenDTO> examenes = new();
    List<DoctorDTO> doctores = new();
    List<PacienteDTO> pacientes = new();

    private string estadoSeleccionado = "Todos";

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    private async Task Load()
    {
        resultados = await resultadoService.GetResultados();
        examenes = await examenService.GetExamenes();
        doctores = await doctorService.GetDoctors();
        pacientes = await pacienteService.GetPacientes();

        foreach (var r in resultados)
        {
            r.Examen = examenes.FirstOrDefault(e => e.Id == r.IdExamen);
            r.Doctor = doctores.FirstOrDefault(d => d.Id == r.IdDoctor);

            if (r.Examen != null)
                r.Paciente = pacientes.FirstOrDefault(p => p.Id == r.Examen.IdPaciente);
        }

        resultadosFiltrados = resultados.ToList();
    }

    private void Filtrar(ChangeEventArgs e)
    {
        string texto = e.Value?.ToString()?.ToLower() ?? "";

        resultadosFiltrados = resultados.Where(r =>
            $"{r.Paciente?.Nombre} {r.Paciente?.Apellido}".ToLower().Contains(texto) ||
            r.Examen?.TipoExamen?.ToLower().Contains(texto) == true
        ).ToList();
    }

    private List<string> EstadosUnicos =>
        resultados
        .Select(r => r.Estado)
        .Distinct()
        .OrderBy(r => r)
        .ToList();

    private IEnumerable<ResultadoDTO> ResultadosFiltradosEstado =>
        estadoSeleccionado == "Todos"
            ? resultadosFiltrados
            : resultadosFiltrados.Where(r => r.Estado == estadoSeleccionado);

    private void SeleccionarEstado(string estado)
    {
        estadoSeleccionado = estado;
    }

    private string ClaseEstado(string estado)
    {
        return estado switch
        {
            "Validado" => "bg-success",
            "Entregado" => "bg-info",
            "Anulado" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private void EditarResultado(int id)
    {
        nav.NavigateTo($"/resultados/editarResultado/{id}");
    }
}
