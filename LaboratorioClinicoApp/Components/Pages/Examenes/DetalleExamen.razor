@page "/examenes/detalle/{id:int}"

@using LaboratorioClinicoApp.DTO
@using LaboratorioClinicoApp.Services

@inject ExamenService examenService
@inject PacienteService pacienteService
@inject NavigationManager nav

<link rel="stylesheet" href="/css/examenes/detalleExamenes.css" />

<div class="detalle-container">

    <h3>Detalle del Examen</h3>

    @if (examen == null)
    {
        <p>Cargando...</p>
    }
    else
    {
        <div class="detalle-card">

            <div class="info-box">
                <label>Tipo de Examen:</label>
                <p>@examen.TipoExamen</p>
            </div>

            <div class="info-box">
                <label>Descripción:</label>
                <p>@examen.Descripcion</p>
            </div>

            <div class="info-box">
                <label>Fecha:</label>
                <p>@examen.Fecha.ToString("dd/MM/yyyy HH:mm")</p>
            </div>

            <div class="info-box">
                <label>Estado:</label>
                <span class="estado @EstadoClase(examen.Estado)">
                    @examen.Estado
                </span>
            </div>

            <div class="info-box">
                <label>Paciente:</label>
                <p>@NombrePaciente()</p>
            </div>

            <div class="text-center mt-3">
                <button class="btn btn-success"
                        @onclick='() => nav.NavigateTo($"/examenes/editarExamenes/{id}")'>
                    Editar
                </button>
                <button class="btn btn-secondary ms-2"
                        @onclick='() => nav.NavigateTo("/examenes")'>
                    Volver
                </button>
            </div>

        </div>
    }
</div>

@code {
    [Parameter] public int id { get; set; }

    ExamenDTO? examen;
    PacienteDTO? paciente;

    protected override async Task OnInitializedAsync()
    {
        examen = await examenService.GetExamenById(id);

        if (examen != null)
        {
            var allPacientes = await pacienteService.GetPacientes();
            paciente = allPacientes.FirstOrDefault(p => p.Id == examen.IdPaciente);
        }
    }

    private string NombrePaciente()
    {
        if (paciente != null)
            return $"{paciente.Nombre} {paciente.Apellido}";

        return examen?.PacienteNombre ?? "Sin datos";
    }

    private string EstadoClase(string estado)
    {
        return estado.ToLower() switch
        {
            "pendiente" => "pendiente",
            "completado" => "completado",
            "cancelado" => "cancelado",
            _ => ""
        };
    }
}
