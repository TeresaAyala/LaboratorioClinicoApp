@page "/resultados/detalle/{id:int}"

@using LaboratorioClinicoApp.Services
@using LaboratorioClinicoApp.DTO

@inject ResultadoService resultadoService
@inject ExamenService examenService
@inject DoctorService doctorService
@inject PacienteService pacienteService
@inject NavigationManager nav
@inject IJSRuntime JS

<link rel="stylesheet" href="css/Resultados/detalleresultado.css" />

<div class="container my-5">
    <div class="card shadow-lg border-0">
        <div class="card-header bg-primary text-white text-center">
            <h3 class="mb-0">Detalle del Resultado</h3>
        </div>

        <div class="card-body">

            @if (resultado == null)
            {
                <p>Cargando...</p>
            }
            else
            {
                <div class="row mb-3">
                    <div class="col-6"><strong>Paciente:</strong> @nombrePaciente</div>
                    <div class="col-6"><strong>Doctor:</strong> @nombreDoctor</div>
                </div>

                <div class="row mb-3">
                    <div class="col-6"><strong>Tipo de Examen:</strong> @tipoExamen</div>
                    <div class="col-6"><strong>Fecha Emisión:</strong> @resultado.FechaEmision.ToString("yyyy-MM-dd HH:mm")</div>
                </div>

                <div class="mb-3">
                    <strong>Estado:</strong>
                    <span class="badge @(ClaseEstado(resultado.Estado))">
                        @resultado.Estado
                    </span>
                </div>

                <div class="mb-3">
                    <strong>Detalle del Resultado:</strong>
                    <p>@resultado.Detalle</p>
                </div>

                <!-- Botones alineados uno a cada lado -->
                <div class="d-flex justify-content-between mt-4">
                    <button class="btn btn-danger" @onclick="GenerarPDF">
                        Descargar PDF Clínico
                    </button>

                    <button class="btn btn-secondary" @onclick='() => nav.NavigateTo("/resultados")'>
                        Volver
                    </button>
                </div>
            }

        </div>
    </div>
</div>

@code {

    [Parameter] public int id { get; set; }

    ResultadoDTO resultado = new();

    string nombrePaciente = "";
    string nombreDoctor = "";
    string tipoExamen = "";

    protected override async Task OnInitializedAsync()
    {
        var lista = await resultadoService.GetResultados();
        resultado = lista.FirstOrDefault(r => r.Id == id);

        if (resultado == null)
            return;

        // Obtener EXAMEN
        var exam = await examenService.GetExamenById(resultado.IdExamen);
        tipoExamen = exam?.TipoExamen ?? "Desconocido";

        // Obtener DOCTOR
        var doctor = await doctorService.GetDoctorById(resultado.IdDoctor);
        nombreDoctor = doctor != null ? $"{doctor.Nombre} {doctor.Apellido}" : "No registrado";

        // Obtener PACIENTE correctamente
        if (resultado.Paciente != null)
        {
            nombrePaciente = $"{resultado.Paciente.Nombre} {resultado.Paciente.Apellido}";
        }
        else if (exam != null)
        {
            var paciente = await pacienteService.GetPacienteById(exam.IdPaciente);
            nombrePaciente = paciente != null
                ? $"{paciente.Nombre} {paciente.Apellido}"
                : "No registrado";
        }
        else
        {
            nombrePaciente = "No registrado";
        }
    }

    private async Task GenerarPDF()
    {
        var data = new
        {
            idResultado = resultado.Id,
            paciente = nombrePaciente,
            doctor = nombreDoctor,
            examen = tipoExamen,
            fecha = resultado.FechaEmision.ToString("yyyy-MM-dd HH:mm"),
            estado = resultado.Estado,
            detalle = resultado.Detalle,
            clinica = "Laboratorio Clínico "
        };

        await JS.InvokeVoidAsync("GenerarPDFResultadoClinico", data);
    }

    // ✅ FUNCIÓN PARA ASIGNAR COLORES SEGÚN ESTADO
    private string ClaseEstado(string estado)
    {
        return estado switch
        {
            "Validado" => "bg-success",
            "Entregado" => "bg-primary",
            "Anulado" => "bg-danger",
            _ => "bg-secondary"
        };
    }
}
