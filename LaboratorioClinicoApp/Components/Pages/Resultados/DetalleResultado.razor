@page "/resultados/detalle/{id:int}"

@using LaboratorioClinicoApp.Services
@using LaboratorioClinicoApp.DTO

@inject ResultadoService resultadoService
@inject ExamenService examenService
@inject DoctorService doctorService
@inject PacienteService pacienteService
@inject NavigationManager nav
@inject IJSRuntime JS

<link rel="stylesheet" href="/css/Resultados/detalleResultado.css" />

<div class="detalle-container">

    <h3>Detalle del Resultado</h3>

    @if (resultado == null)
    {
        <p>Cargando...</p>
    }
    else
    {
        <div class="detalle-card">

            <div class="info-box">
                <label>Paciente:</label>
                <p>@nombrePaciente</p>
            </div>

            <div class="info-box">
                <label>Doctor:</label>
                <p>@nombreDoctor</p>
            </div>

            <div class="info-box">
                <label>Tipo de Examen:</label>
                <p>@tipoExamen</p>
            </div>

            <div class="info-box">
                <label>Fecha de Emisión:</label>
                <p>@resultado.FechaEmision.ToString("dd/MM/yyyy HH:mm")</p>
            </div>

            <div class="info-box">
                <label>Estado:</label>
                <span class="estado @ClaseEstado(resultado.Estado)">
                    @resultado.Estado
                </span>
            </div>

            <div class="info-box">
                <label>Detalle del Resultado:</label>
                <p>@resultado.Detalle</p>
            </div>

            <div class="text-center mt-3">
                <button class="btn btn-success" @onclick="GenerarPDF">
                    Descargar PDF
                </button>

                <button class="btn btn-secondary ms-2"
                        @onclick='() => nav.NavigateTo("/resultados")'>
                    Volver
                </button>
            </div>

        </div>
    }
</div>

@code {

    [Parameter] public int id { get; set; }

    ResultadoDTO resultado = new();

    string nombrePaciente = "";
    string nombreDoctor = "";
    string tipoExamen = "";

    protected override async Task OnInitializedAsync()
    {
        var lista = await resultadoService.GetResultados();
        resultado = lista.FirstOrDefault(r => r.Id == id);

        if (resultado == null)
            return;

        var exam = await examenService.GetExamenById(resultado.IdExamen);
        tipoExamen = exam?.TipoExamen ?? "Desconocido";

        var doctor = await doctorService.GetDoctorById(resultado.IdDoctor);
        nombreDoctor = doctor != null ? $"{doctor.Nombre} {doctor.Apellido}" : "No registrado";

        if (resultado.Paciente != null)
        {
            nombrePaciente = $"{resultado.Paciente.Nombre} {resultado.Paciente.Apellido}";
        }
        else if (exam != null)
        {
            var paciente = await pacienteService.GetPacienteById(exam.IdPaciente);
            nombrePaciente = paciente != null
                ? $"{paciente.Nombre} {paciente.Apellido}"
                : "No registrado";
        }
    }

    private async Task GenerarPDF()
    {
        var data = new
        {
            idResultado = resultado.Id,
            paciente = nombrePaciente,
            doctor = nombreDoctor,
            examen = tipoExamen,
            fecha = resultado.FechaEmision.ToString("yyyy-MM-dd HH:mm"),
            estado = resultado.Estado,
            detalle = resultado.Detalle,
            clinica = "Laboratorio Clínico "
        };

        await JS.InvokeVoidAsync("GenerarPDFResultadoClinico", data);
    }

    private string ClaseEstado(string estado)
    {
        return estado switch
        {
            "Validado" => "completado",
            "Entregado" => "pendiente",
            "Anulado" => "cancelado",
            _ => ""
        };
    }
}
