@page "/resultados/editarResultado/{id:int}"

@using LaboratorioClinicoApp.DTO
@using LaboratorioClinicoApp.Services

@inject ResultadoService resultadoService
@inject PacienteService pacienteService
@inject ExamenService examenService
@inject DoctorService doctorService
@inject NavigationManager navManager

<link rel="stylesheet" href="/bootstrap/bootstrap.min.css" />
<link rel="stylesheet" href="/css/Resultados/formularioAgregarEditarResultado.css" />

<div class="container my-4">
    <h3 class="text-center mb-3">Editar Resultado</h3>

    @if (resultado == null)
    {
        <p>Cargando...</p>
    }
    else
    {
        <EditForm Model="@resultado" OnValidSubmit="ConfirmarGuardar">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <!-- PACIENTE -->
            <div class="mb-3">
                <label class="form-label">Paciente *</label>
                <InputSelect class="form-select" @bind-Value="resultado.IdPaciente" @onchange="FiltrarExamenes" required>
                    <option value="">Seleccione un paciente</option>
                    @foreach (var p in pacientes)
                    {
                        <option value="@p.Id">@p.Nombre @p.Apellido</option>
                    }
                </InputSelect>
            </div>

            <!-- EXAMEN -->
            <div class="mb-3">
                <label class="form-label">Examen *</label>
                <InputSelect class="form-select" @bind-Value="resultado.IdExamen" required>
                    <option value="">Seleccione un examen</option>
                    @foreach (var ex in examenesFiltrados)
                    {
                        <option value="@ex.Id">@ex.TipoExamen</option>
                    }
                </InputSelect>
            </div>

            <!-- DOCTOR -->
            <div class="mb-3">
                <label class="form-label">Doctor *</label>
                <InputSelect class="form-select" @bind-Value="resultado.IdDoctor" required>
                    <option value="">Seleccione un doctor</option>
                    @foreach (var d in doctores)
                    {
                        <option value="@d.Id">@d.Nombre @d.Apellido</option>
                    }
                </InputSelect>
            </div>

            <!-- FECHA -->
            <div class="mb-3">
                <label class="form-label">Fecha de Emisión *</label>
                <InputDate class="form-control" @bind-Value="resultado.FechaEmision" required />
            </div>

            <!-- DETALLE -->
            <div class="mb-3">
                <label class="form-label">Detalle del Resultado *</label>
                <InputTextArea class="form-control" rows="3" @bind-Value="resultado.Detalle" required />
            </div>

            <!-- ESTADO -->
            <div class="mb-3">
                <label class="form-label">Estado *</label>
                <InputSelect class="form-select" @bind-Value="resultado.Estado" required>
                    <option value="Validado">Validado</option>
                    <option value="Entregado">Entregado</option>
                    <option value="Anulado">Anulado</option>
                </InputSelect>
            </div>

            <!-- BOTONES -->
            <div class="text-center mt-3">
                <button type="submit" class="btn btn-success">Guardar</button>
                <button type="button" class="btn btn-secondary ms-2" @onclick="Cancelar">Cancelar</button>
            </div>
        </EditForm>
    }
</div>

<!-- MODAL DE CONFIRMACIÓN -->
@if (mostrarConfirmacion)
{
    <div class="modal-overlay">
        <div class="modal-box">
            <h5>Confirmar cambios</h5>
            <p>¿Está seguro que desea guardar los cambios?</p>
            <div class="text-center mt-3">
                <button class="btn btn-success me-2" @onclick="GuardarResultado">Sí, guardar</button>
                <button class="btn btn-secondary" @onclick="()=>mostrarConfirmacion=false">Cancelar</button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int id { get; set; }

    ResultadoDTO? resultado;
    List<PacienteDTO> pacientes = new();
    List<DoctorDTO> doctores = new();
    List<ExamenDTO> examenes = new();
    List<ExamenDTO> examenesFiltrados = new();

    private bool mostrarConfirmacion = false;

    protected override async Task OnInitializedAsync()
    {
        pacientes = await pacienteService.GetPacientes();
        doctores = await doctorService.GetDoctors();
        examenes = await examenService.GetExamenes();

        resultado = await resultadoService.GetResultadoById(id);

        if (resultado != null)
        {
            examenesFiltrados = examenes.Where(x => x.IdPaciente == resultado.IdPaciente).ToList();
        }
    }

    private void FiltrarExamenes(ChangeEventArgs e)
    {
        int idPaciente = int.Parse(e.Value.ToString());
        examenesFiltrados = examenes.Where(x => x.IdPaciente == idPaciente).ToList();
    }

    private void ConfirmarGuardar()
    {
        mostrarConfirmacion = true;
    }

    private async Task GuardarResultado()
    {
        mostrarConfirmacion = false;
        await resultadoService.UpdateResultado(id, resultado);
        navManager.NavigateTo("/resultados");
    }

    private void Cancelar()
    {
        navManager.NavigateTo("/resultados");
    }
}
