@page "/pacientes"
@using LaboratorioClinicoApp.Services
@using LaboratorioClinicoApp.DTO
@inject PacienteService pacienteService
@inject NavigationManager nav

<link rel="stylesheet" href="/css/Pacientes/pacientes.css" />

<div class="pacientes-container">

    <!-- HEADER -->
    <div class="top-bar">
        <h2>Pacientes</h2>
        <button class="btn-crear" @onclick='() => nav.NavigateTo("/pacientes/agregarPaciente")'>
            + Crear Paciente
        </button>
    </div>

    <!-- BUSCADOR -->
    <div class="buscador-container">
        <input placeholder="Buscar por nombre o ID..."
               @bind="searchTerm" @bind:event="oninput" />
    </div>

    <!-- FILTROS -->
    <div class="filtros-container">
        @foreach (var f in Filtros)
        {
            <button class="filtro-btn @(FiltroActivo(f) ? "activo" : "")"
                    @onclick="() => CambiarFiltro(f)">
                @f
            </button>
        }
    </div>

    <!-- LISTA -->
    @if (cargando)
    {
        <p>Cargando pacientes...</p>
    }
    else
    {
        @foreach (var p in PacientesFiltrados)
        {
            var color = Colores[p.Id % Colores.Count];

            <div class="paciente-card" @onclick='() => AbrirDetalle(p.Id)'>

                <!-- FOTO / AVATAR EXACTO COMO USUARIOS -->
                <div class="avatar-container">
                    @if (!string.IsNullOrEmpty(p.FotoUrl))
                    {
                        <img src="@p.FotoUrl" class="avatar-img" />
                    }
                    else
                    {
                        <div class="avatar-fallback" style="background:@color">
                            @p.Nombre.Substring(0, 1).ToUpper()
                        </div>
                    }
                </div>

                <div class="paciente-info">
                    <h4>@p.Nombre @p.Apellido</h4>
                    <small>Email: @p.Email</small>
                </div>

                <span class="flecha">›</span>
            </div>
        }
    }
</div>

@code {
    private List<PacienteDTO> pacientes = new();
    private string searchTerm = "";
    private string filtro = "Todos";
    private bool cargando = true;

    private List<string> Filtros = new()
    { "Todos", "Activo", "Inactivo", "En tratamiento", "Suspendido", "Fallecido" };

    // COLORES IGUALES A USUARIOS
    List<string> Colores = new()
    {
        "#3f51b5","#009688","#9c27b0","#2196f3",
        "#ff9800","#e91e63","#4caf50","#795548"
    };

    protected override async Task OnInitializedAsync()
    {
        pacientes = await pacienteService.GetPacientes() ?? new();
        cargando = false;
        StateHasChanged();
    }

    bool FiltroActivo(string f) => filtro == f;

    void CambiarFiltro(string f)
    {
        filtro = f;
    }

    void AbrirDetalle(int id)
    {
        nav.NavigateTo($"/pacientes/detallePaciente/{id}");
    }

    IEnumerable<PacienteDTO> PacientesFiltrados =>
        pacientes.Where(p =>
            (filtro == "Todos" || p.Estado == filtro) &&
            (string.IsNullOrWhiteSpace(searchTerm)
            || $"{p.Nombre} {p.Apellido}".Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
            || p.Id.ToString().Contains(searchTerm))
        );
}
