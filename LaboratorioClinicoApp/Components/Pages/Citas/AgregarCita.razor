@page "/citas/agregar"
@using LaboratorioClinicoApp.Services
@using LaboratorioClinicoApp.DTO
@inject CitaService citaService
@inject PacienteService pacienteService
@inject NavigationManager navManager
@inject IJSRuntime JSRuntime

<link rel="stylesheet" href="/bootstrap/bootstrap.min.css" />
<link rel="stylesheet" href="/css/Cita/agregarCita.css" />

<EditForm EditContext="@editContext" OnValidSubmit="GuardarCita">
    <DataAnnotationsValidator />

    <div class="form-wrapper">
        <div class="form-contenedor">

            <div class="main-container-form">
                <h3>🧪 Agendar Cita de Examen</h3>
                <p class="subtitle">Complete los campos para registrar una nueva cita de examen.</p>

                <div class="form-container">

                    <div class="section-title">Información del Paciente</div>

                    <div class="form-group-flex">
                        <div class="input-group">
                            <label>Paciente <span class="required">*</span></label>

                            <input list="listaPacientes"
                                   class="form-control"
                                   @bind="textoBusquedaPaciente"
                                   @onblur="BuscarPaciente"
                                   placeholder="Buscar por nombre..." />

                            <datalist id="listaPacientes">
                                @foreach (var p in pacientes)
                                {
                                    <option value="@($"{p.Nombre} {p.Apellido}")"></option>
                                }
                            </datalist>

                            <ValidationMessage For="@(() => cita.IdPaciente)" />
                        </div>

                        <div class="input-group">
                            <label>Motivo <span class="required">*</span></label>
                            <input class="form-control" @bind="cita.Motivo" />
                            <ValidationMessage For="@(() => cita.Motivo)" />
                        </div>
                    </div>

                    <div class="input-group mb-4">
                        <label>Notas (Opcional)</label>
                        <textarea class="form-control" rows="3" @bind="cita.NotasConsulta"></textarea>
                    </div>


                    <div class="section-title">Fecha y Hora</div>

                    <div class="calendar-hour-container">

                        <div class="calendar-box">
                            <label class="calendar-title">Seleccione Fecha</label>

                            <div class="pretty-date-wrapper">
                                <span class="calendar-icon">📅</span>

                                <InputDate @bind-Value="FechaCita"
                                           class="calendar-control-beauty"
                                           min="@FechaMinimaString" />
                            </div>

                            <ValidationMessage For="@(() => cita.FechaHora)" />
                        </div>

                        <div class="hours-box">
                            <label class="hours-title">
                                Horas Disponibles – @FechaCita.ToString("dddd d 'de' MMMM", new System.Globalization.CultureInfo("es-ES"))
                            </label>

                            <div class="hours-grid">
                                @foreach (var h in HorasDisponibles)
                                {
                                    <button type="button"
                                            class="hour-btn @(HoraCitaString == h ? "active" : "")"
                                            @onclick="() => SeleccionarHora(h)">
                                        @h
                                    </button>
                                }

                                @if (HorasDisponibles.Count == 0)
                                {
                                    <p class="sin-horas">No hay horas disponibles.</p>
                                }
                            </div>
                        </div>
                    </div>


                    <div class="form-actions">
                        <button class="btn btn-secondary" type="button" @onclick="Volver">Cancelar</button>
                        <button class="btn btn-primary" type="submit">Guardar Cita de Examen</button>
                    </div>

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger mt-2">@errorMessage</div>
                    }
                </div>
            </div>
        </div>
    </div>
</EditForm>

@if (mostrarExito)
{
    <div class="modal-exito">
        <div class="modal-content">
            <h3>✔️ Su cita fue guardada exitosamente</h3>
            <button class="btn btn-primary" @onclick="CerrarModalExito">Aceptar</button>
        </div>
    </div>
}

@code {
    private CitaDTO cita = new() { Estado = "Activa" };

    private EditContext editContext;
    private List<PacienteDTO> pacientes = new();
    private string textoBusquedaPaciente = string.Empty;
    private string errorMessage = string.Empty;

    // AÑADIDO: Lista de feriados (Mes, Día)
    private readonly List<(int Mes, int Dia)> feriados = new()
    {
        (1, 1),    // Año Nuevo
        (5, 1),    // Día del Trabajo
        (9, 15),   // Día de la Independencia (si aplica a tu país)
        (12, 25)   // Navidad
    };

    // Horas disponibles
    private List<string> HorasTodas = new();
    // 🟢 ARREGLO CLAVE: Filtra HorasTodas para mostrar solo las que NO están en HorasOcupadasSet
    private List<string> HorasDisponibles => HorasTodas
        .Where(h => !HorasOcupadasSet.Contains(h))
        .ToList();

    private HashSet<string> HorasOcupadasSet = new();
    private List<CitaDTO> citasDelDia = new();
    private bool mostrarExito = false;

    protected override async Task OnInitializedAsync()
    {
        // Se asegura que el estado sea "Activo" en la inicialización
        cita = new CitaDTO()
        {
            TipoCita = "EXAMEN",
            Estado = "Activo",
            IdDoctor = null,
            NotasConsulta = ""
        };

        editContext = new EditContext(cita);

        // Ajuste inicial para evitar domingos/feriados al cargar la página
        DateTime inicial = DateTime.Today;
        while (inicial.DayOfWeek == DayOfWeek.Sunday || EsFeriado(inicial))
        {
            inicial = inicial.AddDays(1);
        }

        var prox = AjustarAlSiguienteBloque(DateTime.Now);
        cita.FechaHora = new DateTime(inicial.Year, inicial.Month, inicial.Day, prox.Hour, prox.Minute, 0);

        HorasTodas = GenerarHoras15MinutosParaDia();
        pacientes = await pacienteService.GetPacientes();

        await CargarHorasDisponibles();
    }

    private string FechaMinimaString => DateTime.Today.ToString("yyyy-MM-dd");

    // Método para verificar feriados
    private bool EsFeriado(DateTime f)
        => feriados.Any(x => x.Mes == f.Month && x.Dia == f.Day);

    private DateTime FechaCita
    {
        get => cita.FechaHora.Date;
        set
        {
            // Validar la fecha seleccionada
            if (value.DayOfWeek == DayOfWeek.Sunday)
            {
                errorMessage = "❌ Los domingos no se atiende. Se seleccionó el lunes siguiente.";
                // Buscar el siguiente día hábil después del domingo
                value = value.AddDays(1);
                while (value.DayOfWeek == DayOfWeek.Sunday || EsFeriado(value))
                {
                    value = value.AddDays(1);
                }
            }
            else if (EsFeriado(value))
            {
                errorMessage = "🎌 Ese día es feriado. Se seleccionó el siguiente día hábil.";
                // Buscar el siguiente día hábil
                value = value.AddDays(1);
                while (value.DayOfWeek == DayOfWeek.Sunday || EsFeriado(value))
                {
                    value = value.AddDays(1);
                }
            }
            else
            {
                errorMessage = "";
            }

            // Asegurar que la nueva fecha no sea anterior a hoy
            if (value < DateTime.Today)
            {
                value = DateTime.Today;
                errorMessage = "No se puede agendar citas en días pasados.";
            }

            // Mantenemos la hora actual, pero cambiamos el día
            cita.FechaHora = new DateTime(
                value.Year, value.Month, value.Day,
                cita.FechaHora.Hour, cita.FechaHora.Minute, 0);

            // Esto fuerza al InputDate a actualizarse si hubo un cambio de día (domingo/feriado)
            StateHasChanged();
            _ = CargarHorasDisponibles(); // Recargamos las horas para la nueva fecha
        }
    }

    private List<string> GenerarHoras15MinutosParaDia()
    {
        var lista = new List<string>();
        // Horario de 07:00 a 11:45
        var inicio = new TimeSpan(7, 0, 0);
        var fin = new TimeSpan(12, 0, 0);

        for (var t = inicio; t < fin; t = t.Add(TimeSpan.FromMinutes(15)))
            lista.Add(DateTime.Today.Add(t).ToString("HH:mm"));

        return lista;
    }

    private async Task CargarHorasDisponibles()
    {
        HorasOcupadasSet.Clear();
        citasDelDia.Clear();

        var todas = await citaService.GetCitas(); // Obtener todas las citas para el filtro
        var fecha = cita.FechaHora.Date;

        // Filtrar citas que coinciden con la fecha seleccionada
        citasDelDia = todas
            .Where(c => c.FechaHora.Date == fecha)
            .ToList();

        // Llenar el HashSet con las horas ocupadas (ej: "07:00")
        HorasOcupadasSet = citasDelDia
            .Select(c => c.FechaHora.ToString("HH:mm"))
            .ToHashSet();

        StateHasChanged(); // Refresca la UI para ocultar las horas
    }

    private string HoraCitaString
    {
        get => cita.FechaHora.ToString("HH:mm");
        set
        {
            if (!TimeSpan.TryParse(value, out var t))
                return;

            var fecha = cita.FechaHora.Date;

            var nueva = new DateTime(
                fecha.Year, fecha.Month, fecha.Day,
                t.Hours, t.Minutes, 0);

            // Validación de doble seguridad (aunque ya no debería aparecer en la lista si está ocupada)
            if (HorasOcupadasSet.Contains(value))
            {
                errorMessage = "La hora seleccionada ya está ocupada.";
                return;
            }

            errorMessage = "";
            cita.FechaHora = nueva;
        }
    }

    private void SeleccionarHora(string h)
    {
        HoraCitaString = h;
    }

    private DateTime AjustarAlSiguienteBloque(DateTime now)
    {
        var add = (15 - (now.Minute % 15)) % 15;
        var next = now.AddMinutes(add);
        return new DateTime(next.Year, next.Month, next.Day, next.Hour, next.Minute - (next.Minute % 15), 0);
    }

    private void BuscarPaciente()
    {
        cita.IdPaciente = 0;

        var encontrado = pacientes.FirstOrDefault(p =>
            $"{p.Nombre} {p.Apellido}".Equals(textoBusquedaPaciente.Trim(), StringComparison.OrdinalIgnoreCase));

        if (encontrado != null)
            cita.IdPaciente = encontrado.Id;
    }

    // 🟢 ARREGLO CLAVE: Se actualiza el objeto cita y se recargan las horas después del éxito.
    private async Task GuardarCita()
    {
        errorMessage = "";
        BuscarPaciente();

        if (!editContext.Validate())
            return;

        // Validaciones de día y hora...
        if (cita.FechaHora.DayOfWeek == DayOfWeek.Sunday || EsFeriado(cita.FechaHora))
        {
            errorMessage = "No se permiten citas en este día (domingo/feriado).";
            return;
        }

        var hora = cita.FechaHora.TimeOfDay;
        if (hora < new TimeSpan(7, 0, 0) || hora >= new TimeSpan(12, 0, 0))
        {
            errorMessage = "La hora debe estar entre 07:00 y 11:45.";
            return;
        }
        // ... fin de validaciones

        try
        {
            var todas = await citaService.GetCitas();
            var existe = todas.Any(c => c.FechaHora == cita.FechaHora);

            if (existe)
            {
                errorMessage = "La hora ya fue ocupada por otro usuario. Por favor, selecciona otra hora.";
                await CargarHorasDisponibles();
                return;
            }

            // 1. Guardar
            await citaService.AddCita(cita);

            // 2. Resetear el estado para la próxima posible cita
            cita = new CitaDTO()
            {
                TipoCita = "EXAMEN",
                Estado = "Activo",
                IdDoctor = null,
                NotasConsulta = ""
            };
            editContext = new EditContext(cita);
            textoBusquedaPaciente = string.Empty;

            // 3. Recargar horas ocupadas para ocultar la hora que acabamos de guardar
            await CargarHorasDisponibles();

            mostrarExito = true;
        }
        catch (Exception ex)
        {
            errorMessage = "Error al guardar la cita: " + ex.Message;
        }
    }

    private void CerrarModalExito()
    {
        mostrarExito = false;
        navManager.NavigateTo("/citas");
    }

    private void Volver() => navManager.NavigateTo("/citas");
}