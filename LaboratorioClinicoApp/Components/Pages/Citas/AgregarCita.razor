@page "/citas/agregar"
@using LaboratorioClinicoApp.Services
@using LaboratorioClinicoApp.DTO
@inject CitaService citaService
@inject PacienteService pacienteService
@inject NavigationManager navManager
@inject IJSRuntime JSRuntime

<link rel="stylesheet" href="/css/Cita/agregarCita.css" />

<EditForm EditContext="@editContext" OnValidSubmit="GuardarCita">
    <DataAnnotationsValidator />

    <div class="form-wrapper">
        <div class="form-contenedor">

            <div class="main-container-form">
                <h3>🧪 Agendar Cita de Examen</h3>
                <p class="subtitle">Complete los campos para registrar una nueva cita de examen.</p>

                <div class="form-container">

                    <!-- Tipo -->
                    <div class="form-group-flex">
                        <div class="input-group">
                            <label>Tipo de Cita</label>
                            <input type="text" class="form-control" value="EXAMEN" disabled />
                        </div>
                    </div>

                    <!-- PACIENTE -->
                    <div class="section-title">Información del Paciente</div>

                    <div class="form-group-flex">
                        <div class="input-group">
                            <label>Paciente <span class="required">*</span></label>

                            <input list="listaPacientes"
                                   class="form-control"
                                   @bind="textoBusquedaPaciente"
                                   @onblur="BuscarPaciente"
                                   placeholder="Buscar por nombre..." />

                            <datalist id="listaPacientes">
                                @foreach (var p in pacientes)
                                {
                                    <option value="@($"{p.Nombre} {p.Apellido}")"></option>
                                }
                            </datalist>

                            <ValidationMessage For="@(() => cita.IdPaciente)" />
                        </div>

                        <!-- Motivo -->
                        <div class="input-group">
                            <label>Motivo <span class="required">*</span></label>
                            <input class="form-control" @bind="cita.Motivo" />
                            <ValidationMessage For="@(() => cita.Motivo)" />
                        </div>
                    </div>

                    <!-- FECHA Y HORA -->
                    <div class="section-title">Fecha y Hora</div>

                    <div class="form-group-flex">

                        <!-- Fecha -->
                        <div class="input-group">
                            <label>Fecha</label>
                            <InputDate @bind-Value="FechaCita"
                                       class="form-control"
                                       min="@FechaMinimaString" />
                            <ValidationMessage For="@(() => cita.FechaHora)" />
                        </div>

                        <!-- Hora -->
                        <div class="input-group">
                            <label>Hora</label>
                            <select class="form-control" @bind="HoraCitaString">
                                <option value="">Seleccione una hora</option>
                                @foreach (var h in HorasDisponibles)
                                {
                                    <option value="@h">@h</option>
                                }
                            </select>
                        </div>
                    </div>

                    <!-- ESTADO -->
                    <div class="input-group">
                        <label>Estado</label>
                        <select class="form-control" @bind="cita.Estado">
                            <option value="Activo" selected>Activo</option>
                            <option value="Inactivo">Inactivo</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                    </div>

                    <!-- NOTAS (opcional) -->
                    <div class="input-group">
                        <label>Notas (Opcional)</label>
                        <textarea class="form-control" rows="3" @bind="cita.NotasConsulta"></textarea>
                    </div>

                    <!-- BOTONES -->
                    <div class="form-actions">
                        <button class="btn btn-secondary" type="button" @onclick="Volver">Cancelar</button>
                        <button class="btn btn-primary" type="submit">Guardar Cita de Examen</button>
                    </div>

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger">@errorMessage</div>
                    }
                </div>
            </div>
        </div>
    </div>
</EditForm>

<!-- MODAL ÉXITO -->
@if (mostrarExito)
{
    <div class="modal-exito">
        <div class="modal-content">
            <h3>✔️ Cita registrada correctamente</h3>
            <button class="btn btn-primary" @onclick="CerrarModalExito">Aceptar</button>
        </div>
    </div>
}

@code {
    private CitaDTO cita = new()
    {
        TipoCita = "EXAMEN",
        Estado = "Activo",
        IdDoctor = null,
        NotasConsulta = ""
    };

    private EditContext editContext;

    private List<PacienteDTO> pacientes = new();
    private string textoBusquedaPaciente = string.Empty;
    private string errorMessage = string.Empty;

    private List<CitaDTO> citasDelDia = new();
    private List<string> HorasDisponibles = new();

    private bool mostrarExito = false;

    protected override async Task OnInitializedAsync()
    {
        editContext = new EditContext(cita);

        cita.FechaHora = DateTime.Now.AddMinutes(15);

        pacientes = await pacienteService.GetPacientes();
    }

    private string FechaMinimaString => DateTime.Now.ToString("yyyy-MM-dd");

    private DateTime FechaCita
    {
        get => cita.FechaHora.Date;
        set
        {
            cita.FechaHora = new DateTime(
                value.Year, value.Month, value.Day,
                cita.FechaHora.Hour, cita.FechaHora.Minute, 0
            );

            _ = CargarHorasDisponibles();
        }
    }

    private async Task CargarHorasDisponibles()
    {
        HorasDisponibles.Clear();

        citasDelDia = await citaService.GetCitas();
        citasDelDia = citasDelDia
            .Where(c => c.FechaHora.Date == cita.FechaHora.Date)
            .ToList();

        var ocupadas = citasDelDia
            .Select(c => c.FechaHora.ToString("HH:mm"))
            .ToList();

        var todas = GenerarHoras();

        HorasDisponibles = todas
            .Where(h => !ocupadas.Contains(h))
            .ToList();
    }

    private string HoraCitaString
    {
        get => cita.FechaHora.ToString("HH:mm");
        set
        {
            if (TimeSpan.TryParse(value, out var t))
            {
                cita.FechaHora = new DateTime(
                    cita.FechaHora.Year, cita.FechaHora.Month, cita.FechaHora.Day,
                    t.Hours, t.Minutes, 0
                );
            }
        }
    }

    private List<string> GenerarHoras()
    {
        var lista = new List<string>();
        var inicio = new TimeSpan(7, 0, 0);
        var fin = new TimeSpan(11, 0, 0);

        for (var t = inicio; t <= fin; t = t.Add(TimeSpan.FromMinutes(15)))
            lista.Add(DateTime.Today.Add(t).ToString("HH:mm"));

        return lista;
    }

    private void BuscarPaciente()
    {
        cita.IdPaciente = 0;

        var encontrado = pacientes.FirstOrDefault(p =>
            $"{p.Nombre} {p.Apellido}".Equals(textoBusquedaPaciente.Trim(),
            StringComparison.OrdinalIgnoreCase));

        if (encontrado != null)
            cita.IdPaciente = encontrado.Id;
    }

    private async Task GuardarCita()
    {
        errorMessage = "";

        BuscarPaciente();

        if (!editContext.Validate())
            return;

        try
        {
            await citaService.AddCita(cita);
            mostrarExito = true;
        }
        catch (Exception ex)
        {
            errorMessage = "Error al guardar la cita: " + ex.Message;
        }
    }

    private void CerrarModalExito()
    {
        mostrarExito = false;
        navManager.NavigateTo("/citas");
    }

    private void Volver() => navManager.NavigateTo("/citas");
}
