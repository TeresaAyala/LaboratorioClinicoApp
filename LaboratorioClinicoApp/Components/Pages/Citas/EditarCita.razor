@page "/citas/editar/{id:int}"
@using LaboratorioClinicoApp.Services
@using LaboratorioClinicoApp.DTO
@inject CitaService citaService
@inject PacienteService pacienteService
@inject NavigationManager navManager
@inject IJSRuntime JSRuntime

<link rel="stylesheet" href="/css/Cita/agregarCita.css" />

<EditForm EditContext="@editContext" OnValidSubmit="UpdateCita">
    <DataAnnotationsValidator />

    <div class="form-wrapper">
        <div class="form-contenedor">

            <h3>🧪 Editar Cita de Examen</h3>
            <p class="subtitle">Modifique los datos necesarios.</p>

            <div class="form-container">

                <!-- Tipo -->
                <div class="form-group-flex">
                    <div class="input-group">
                        <label>Tipo de Cita</label>
                        <input type="text" class="form-control" value="EXAMEN" disabled />
                    </div>
                </div>

                <!-- PACIENTE -->
                <div class="section-title">Información del Paciente</div>

                <div class="form-group-flex">
                    <div class="input-group">
                        <label>Paciente</label>

                        <input list="listaPacientes"
                               class="form-control"
                               @bind="textoBusquedaPaciente"
                               @onblur="BuscarPaciente"
                               placeholder="Buscar por nombre..." />

                        <datalist id="listaPacientes">
                            @foreach (var p in pacientes)
                            {
                                <option value="@($"{p.Nombre} {p.Apellido}")"></option>
                            }
                        </datalist>

                        <ValidationMessage For="@(() => cita.IdPaciente)" />
                    </div>

                    <div class="input-group">
                        <label>Motivo</label>
                        <input class="form-control" @bind="cita.Motivo" />
                    </div>
                </div>

                <!-- FECHA Y HORA -->
                <div class="section-title">Fecha y Hora</div>

                <div class="form-group-flex">

                    <!-- Fecha -->
                    <div class="input-group">
                        <label>Fecha</label>
                        <InputDate @bind-Value="FechaCita"
                                   class="form-control"
                                   min="@FechaMinimaString" />
                    </div>

                    <!-- Hora -->
                    <div class="input-group">
                        <label>Hora</label>
                        <select class="form-control" @bind="HoraCitaString">
                            <option value="">Seleccione una hora</option>
                            @foreach (var h in HorasDisponibles)
                            {
                                <option value="@h">@h</option>
                            }
                        </select>
                    </div>
                </div>

                <!-- ESTADO -->
                <div class="input-group">
                    <label>Estado</label>
                    <select class="form-control" @bind="cita.Estado">
                        <option value="Activo">Activo</option>
                        <option value="Inactivo">Inactivo</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                </div>

                <!-- NOTAS -->
                <div class="input-group">
                    <label>Notas (Opcional)</label>
                    <textarea class="form-control" rows="3" @bind="cita.NotasConsulta"></textarea>
                </div>

                <!-- BOTONES -->
                <div class="form-actions">
                    <button class="btn btn-secondary" type="button" @onclick="Volver">Cancelar</button>
                    <button class="btn btn-primary" type="submit">Guardar Cambios</button>
                </div>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger">@errorMessage</div>
                }
            </div>
        </div>
    </div>
</EditForm>

@if (mostrarExito)
{
    <div class="modal-exito">
        <div class="modal-content">
            <h3>✔️ Cita actualizada correctamente</h3>
            <button class="btn btn-primary" @onclick="CerrarModalExito">Aceptar</button>
        </div>
    </div>
}

@code {
    [Parameter] public int id { get; set; }

    private CitaDTO cita = new();
    private EditContext editContext;

    private List<PacienteDTO> pacientes = new();
    private List<CitaDTO> citasDelDia = new();
    private List<string> HorasDisponibles = new();

    private string textoBusquedaPaciente = "";
    private string errorMessage = "";
    private bool mostrarExito = false;

    protected override async Task OnInitializedAsync()
    {
        pacientes = await pacienteService.GetPacientes();
        cita = await citaService.GetCitaById(id) ?? new CitaDTO();

        // 🔍 DEBUG PARA SABER QUÉ PASA
        await JSRuntime.InvokeVoidAsync("console.log", "➡️ ID recibido:", id);

        if (cita == null || cita.Id == 0)
        {
            await JSRuntime.InvokeVoidAsync("console.log", "❌ La cita NO se cargó. GetCitaById devolvió null o Id=0");
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("console.log", "✔️ Cita cargada correctamente:", cita);
        }

        textoBusquedaPaciente = pacientes
            .Where(p => p.Id == cita.IdPaciente)
            .Select(p => $"{p.Nombre} {p.Apellido}")
            .FirstOrDefault();

        editContext = new EditContext(cita);

        await CargarHorasDisponibles();
    }


    private string FechaMinimaString => DateTime.Now.ToString("yyyy-MM-dd");

    private DateTime FechaCita
    {
        get => cita.FechaHora.Date;
        set
        {
            cita.FechaHora = new DateTime(value.Year, value.Month, value.Day,
                cita.FechaHora.Hour, cita.FechaHora.Minute, 0);

            _ = CargarHorasDisponibles();
        }
    }

    private async Task CargarHorasDisponibles()
    {
        HorasDisponibles.Clear();

        citasDelDia = (await citaService.GetCitas())
            .Where(c => c.FechaHora.Date == cita.FechaHora.Date && c.Id != cita.Id)
            .ToList();

        var ocupadas = citasDelDia.Select(c => c.FechaHora.ToString("HH:mm")).ToList();

        var todas = GenerarHoras();

        HorasDisponibles = todas.Where(h => !ocupadas.Contains(h)).ToList();
    }

    private string HoraCitaString
    {
        get => cita.FechaHora.ToString("HH:mm");
        set
        {
            if (TimeSpan.TryParse(value, out var t))
                cita.FechaHora = cita.FechaHora.Date + t;
        }
    }

    private List<string> GenerarHoras()
    {
        var lista = new List<string>();

        var inicio = new TimeSpan(7, 0, 0);
        var fin = new TimeSpan(11, 0, 0);

        for (var t = inicio; t <= fin; t = t.Add(TimeSpan.FromMinutes(15)))
            lista.Add(DateTime.Today.Add(t).ToString("HH:mm"));

        return lista;
    }

    private void BuscarPaciente()
    {
        cita.IdPaciente = 0;

        var encontrado = pacientes.FirstOrDefault(p =>
            $"{p.Nombre} {p.Apellido}".Equals(textoBusquedaPaciente.Trim(), StringComparison.OrdinalIgnoreCase));

        if (encontrado != null)
            cita.IdPaciente = encontrado.Id;
    }

    private async Task UpdateCita()
    {
        errorMessage = "";
        BuscarPaciente();

        if (!editContext.Validate())
            return;

        try
        {
            await citaService.UpdateCita(cita.Id, cita);
            mostrarExito = true;
        }
        catch (Exception ex)
        {
            errorMessage = "Error al actualizar la cita: " + ex.Message;
        }
    }

    private void CerrarModalExito()
    {
        mostrarExito = false;
        navManager.NavigateTo("/citas");
    }

    private void Volver() => navManager.NavigateTo("/citas");
}
