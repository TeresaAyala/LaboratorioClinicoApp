@page "/citas/editar/{id:int}"
@using LaboratorioClinicoApp.Services
@using LaboratorioClinicoApp.DTO
@inject CitaService citaService
@inject PacienteService pacienteService
@inject NavigationManager navManager
@inject IJSRuntime JSRuntime

<link rel="stylesheet" href="/bootstrap/bootstrap.min.css" />
<link rel="stylesheet" href="/css/Cita/agregarCita.css" />

<EditForm EditContext="@editContext" OnValidSubmit="ActualizarCita">
    <DataAnnotationsValidator />

    <div class="form-wrapper">
        <div class="form-contenedor">

            <div class="main-container-form">
                <h3>📝 Editar Cita de Examen</h3>
                <p class="subtitle">Modifique los datos necesarios.</p>

                <div class="form-container">

                    <!-- Tipo -->
                    <div class="form-group-flex">
                        <div class="input-group">
                            <label>Tipo de Cita</label>
                            <input type="text" class="form-control" value="EXAMEN" disabled />
                        </div>
                    </div>

                    <!-- PACIENTE -->
                    <div class="section-title">Información del Paciente</div>

                    <div class="form-group-flex">
                        <div class="input-group">
                            <label>Paciente <span class="required">*</span></label>

                            <input list="listaPacientes"
                                   class="form-control"
                                   @bind="textoBusquedaPaciente"
                                   @onblur="BuscarPaciente"
                                   placeholder="Buscar por nombre..." />

                            <datalist id="listaPacientes">
                                @foreach (var p in pacientes)
                                {
                                    <option value="@($"{p.Nombre} {p.Apellido}")"></option>
                                }
                            </datalist>

                            <ValidationMessage For="@(() => cita.IdPaciente)" />
                        </div>

                        <div class="input-group">
                            <label>Motivo <span class="required">*</span></label>
                            <input class="form-control" @bind="cita.Motivo" />
                        </div>
                    </div>

                    <!-- FECHA Y HORA -->
                    <div class="section-title">Fecha y Hora</div>

                    <div class="calendar-hour-container">

                        <!-- CALENDARIO BONITO -->
                        <div class="calendar-box">
                            <label class="calendar-title">Seleccione Fecha</label>

                            <div class="pretty-date-wrapper">
                                <span class="calendar-icon">📅</span>

                                <InputDate @bind-Value="FechaCita"
                                           class="calendar-control-beauty"
                                           min="@FechaMinimaString" />
                            </div>
                        </div>

                        <!-- HORAS -->
                        <div class="hours-box">
                            <label class="hours-title">
                                Horas Disponibles – @FechaCita.ToString("dddd d 'de' MMMM")
                            </label>

                            <div class="hours-grid">
                                @foreach (var h in HorasDisponibles)
                                {
                                    <button type="button"
                                            class="hour-btn @(HoraCitaString == h ? "active" : "")"
                                            @onclick="() => SeleccionarHora(h)">
                                        @h
                                    </button>
                                }

                                @if (HorasDisponibles.Count == 0)
                                {
                                    <p class="sin-horas">No hay horas disponibles.</p>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- ESTADO -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Estado</label>
                        <InputSelect @bind-Value="cita.Estado" class="form-select">
                            <option value="Activo">Activo</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Cancelado">Cancelado</option>
                        </InputSelect>
                    </div>

                    <!-- NOTAS -->
                    <div class="input-group">
                        <label>Notas (Opcional)</label>
                        <textarea class="form-control" rows="3" @bind="cita.NotasConsulta"></textarea>
                    </div>

                    <!-- BOTONES -->
                    <div class="form-actions">
                        <button class="btn btn-secondary" type="button" @onclick="Volver">Cancelar</button>
                        <button class="btn btn-primary" type="submit">Guardar Cambios</button>
                    </div>

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger">@errorMessage</div>
                    }
                </div>
            </div>
        </div>
    </div>
</EditForm>

@if (mostrarExito)
{
    <div class="modal-exito">
        <div class="modal-content">
            <h3>✔️ Cita actualizada correctamente</h3>
            <button class="btn btn-primary" @onclick="CerrarModalExito">Aceptar</button>
        </div>
    </div>
}

@code {
    [Parameter] public int id { get; set; }

    private CitaDTO cita = new();
    private EditContext editContext;

    private List<PacienteDTO> pacientes = new();
    private List<CitaDTO> citasDelDia = new();

    private List<string> HorasTodas = new();
    private HashSet<string> HorasOcupadas = new();

    private string textoBusquedaPaciente = "";
    private string errorMessage = "";
    private bool mostrarExito = false;

    protected override async Task OnInitializedAsync()
    {
        pacientes = await pacienteService.GetPacientes();
        cita = await citaService.GetCitaById(id) ?? new CitaDTO();

        editContext = new EditContext(cita);

        textoBusquedaPaciente = pacientes
            .Where(p => p.Id == cita.IdPaciente)
            .Select(p => $"{p.Nombre} {p.Apellido}")
            .FirstOrDefault();

        HorasTodas = GenerarHoras();
        await CargarHoras();

        StateHasChanged();
    }

    private string FechaMinimaString => DateTime.Now.ToString("yyyy-MM-dd");

    private DateTime FechaCita
    {
        get => cita.FechaHora.Date;
        set
        {
            cita.FechaHora = new DateTime(
                value.Year, value.Month, value.Day,
                cita.FechaHora.Hour, cita.FechaHora.Minute, 0);

            _ = CargarHoras();
        }
    }

    private List<string> HorasDisponibles =>
        HorasTodas.Where(h => !HorasOcupadas.Contains(h) || h == HoraCitaString).ToList();

    private async Task CargarHoras()
    {
        var todas = await citaService.GetCitas();
        citasDelDia = todas.Where(c => c.FechaHora.Date == cita.FechaHora.Date && c.Id != cita.Id).ToList();
        HorasOcupadas = citasDelDia.Select(c => c.FechaHora.ToString("HH:mm")).ToHashSet();
    }

    private string HoraCitaString
    {
        get => cita.FechaHora.ToString("HH:mm");
        set
        {
            if (TimeSpan.TryParse(value, out var t))
                cita.FechaHora = cita.FechaHora.Date + t;
        }
    }

    private void SeleccionarHora(string h)
    {
        HoraCitaString = h;
    }

    private List<string> GenerarHoras()
    {
        var lista = new List<string>();
        var inicio = new TimeSpan(7, 0, 0);
        var fin = new TimeSpan(11, 45, 0);

        for (var t = inicio; t <= fin; t = t.Add(TimeSpan.FromMinutes(15)))
            lista.Add(DateTime.Today.Add(t).ToString("HH:mm"));

        return lista;
    }

    private void BuscarPaciente()
    {
        cita.IdPaciente = pacientes
            .Where(p => $"{p.Nombre} {p.Apellido}".Equals(textoBusquedaPaciente.Trim(), StringComparison.OrdinalIgnoreCase))
            .Select(p => p.Id)
            .FirstOrDefault();
    }

    private async Task ActualizarCita()
    {
        BuscarPaciente();

        if (!editContext.Validate())
            return;

        try
        {
            await citaService.UpdateCita(cita.Id, cita);
            mostrarExito = true;
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }

    private void CerrarModalExito()
    {
        mostrarExito = false;
        navManager.NavigateTo("/citas");
    }

    private void Volver() => navManager.NavigateTo("/citas");
}
