@page "/citas"
@using LaboratorioClinicoApp.Services
@using LaboratorioClinicoApp.DTO

@inject CitaService citaService
@inject PacienteService pacienteService
@inject DoctorService doctorService
@inject NavigationManager navManager

<link href="/css/Cita/cita.css" rel="stylesheet" />

<div class="agenda-header">
    <button class="icon-btn" @onclick="IrHoy">📅</button>

    <div class="agenda-center">
        <div class="agenda-title">Agenda</div>

        <div class="agenda-tabs">
            <button class="tab @(vistaDia ? "active" : "")" @onclick="() => CambiarVista(VistaType.Dia)">Día</button>
            <button class="tab @(vistaSemana ? "active" : "")" @onclick="() => CambiarVista(VistaType.Semana)">Semana</button>
            <button class="tab @(vistaMes ? "active" : "")" @onclick="() => CambiarVista(VistaType.Mes)">Mes</button>
        </div>

        <div class="agenda-date">
            <button class="small-nav" @onclick="DiaAnterior">◀</button>
            <div class="today-label">@fechaSeleccionada.ToString("dddd, dd 'de' MMMM yyyy")</div>
            <button class="small-nav" @onclick="DiaSiguiente">▶</button>
        </div>
    </div>

    <button class="icon-btn">👤</button>
</div>

<!-- TABS SUPERIORES -->
<div class="top-tabs">
    <button class="top-tab active">Consulta Médica</button>

    <div class="top-tabs">
        <button class="top-tab active"
                @onclick='() => navManager.NavigateTo("/citas")'>
            Consulta Médica
        </button>

        <button class="top-tab"
                @onclick='() => navManager.NavigateTo("/consulta")'>
            Citas de Exámenes
        </button>
    </div>

</div>

<!-- FILTROS -->
<div class="filtros">
    <div class="filtro-item">
        <label>Doctor</label>
        <select class="form-select" @onchange="OnFilterDoctorChange">
            <option value="">Todos los doctores</option>
            @foreach (var d in doctores)
            {
                <option value="@d.Id">@($"{d.Nombre} {d.Apellido}")</option>
            }
        </select>
    </div>

    <div class="filtro-item">
        <label>Mes</label>
        <select class="form-select" @onchange="OnFilterMesChange">
            <option value="">Todos</option>
            @for (int m = 1; m <= 12; m++)
            {
                <option value="@m">@((new DateTime(2000, m, 1)).ToString("MMMM"))</option>
            }
        </select>
    </div>

    <div class="filtro-item">
        <label>Fecha</label>
        <input type="date" class="form-control" @onchange="OnFilterFechaChange" />
    </div>

    <div class="filtro-item">
        <label>Paciente</label>
        <select class="form-select" @onchange="OnFilterPacienteChange">
            <option value="">Todos los pacientes</option>
            @foreach (var p in pacientes)
            {
                <option value="@p.Id">@($"{p.Nombre} {p.Apellido}")</option>
            }
        </select>
    </div>

    <div class="filtro-item">
        <label>Estado</label>
        <select class="form-select" @onchange="OnFilterEstadoChange">
            <option value="">Todos</option>
            <option value="Confirmada">Confirmada</option>
            <option value="Pendiente">Pendiente</option>
            <option value="Activo">Activo</option>
        </select>
    </div>

    <div class="filtro-actions">
        <button class="btn btn-primary btn-sm" @onclick="NuevaCita">＋ Nueva</button>
    </div>
</div>

<!-- LISTADO -->
<div class="page-container">
    @if (isLoading)
    {
        <div class="loading">Cargando citas...</div>
    }
    else if (citasFiltradas.Count == 0)
    {
        <p class="sin-citas">No hay citas para esta fecha.</p>
    }
    else
    {
        @foreach (var cita in citasFiltradas)
        {
            <div class="cita-card">

                <div class="cita-hora">
                    <span class="hora-num">@cita.FechaHora.ToString("hh:mm")</span>
                    <span class="hora-ampm">@cita.FechaHora.ToString("tt")</span>
                </div>

                <div class="cita-info">

                    <div class="motivo">@cita.Motivo</div>

                    <div class="meta-line">
                        <strong>Fecha:</strong> @cita.FechaHora.ToString("dd 'de' MMMM yyyy")
                    </div>

                    <div class="meta-line">
                        <strong>Paciente:</strong> @GetNombrePaciente(cita.IdPaciente)
                    </div>

                    <div class="meta-line">
                        <strong>Doctor:</strong> @GetNombreDoctor(cita.IdDoctor)
                    </div>

                    <div class="status-row">
                        @if (cita.Estado == "Confirmada")
                        {
                            <span class="badge badge-confirmed">Confirmada</span>
                        }
                        else
                        {
                            <span class="badge badge-pending">Pendiente</span>
                        }
                    </div>

                </div>

                <div class="cita-actions">
                    <button class="btn-edit" @onclick='() => navManager.NavigateTo($"/citas/editar/{cita.Id}")'>Editar</button>
                </div>

            </div>
        }
    }
</div>

@code {

    private List<CitaDTO> citas = new();
    private List<CitaDTO> citasFiltradas = new();
    private List<PacienteDTO> pacientes = new();
    private List<DoctorDTO> doctores = new();

    private DateTime fechaSeleccionada = DateTime.Today;

    bool vistaDia = true;
    bool vistaSemana = false;
    bool vistaMes = false;

    private int? filtroDoctor = null;
    private int? filtroPaciente = null;
    private string? filtroEstado = null;
    private int? filtroMes = null;

    private bool isLoading = true;

    enum VistaType { Dia, Semana, Mes }

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;

        citas = await citaService.GetCitas();
        pacientes = await pacienteService.GetPacientes();
        doctores = await doctorService.GetDoctors();

        FiltrarCitas();
        isLoading = false;
    }

    private void FiltrarCitas()
    {
        var query = citas.AsQueryable();

        if (vistaDia)
            query = query.Where(c => c.FechaHora.Date == fechaSeleccionada.Date);

        if (filtroDoctor.HasValue)
            query = query.Where(c => c.IdDoctor == filtroDoctor.Value);

        if (filtroPaciente.HasValue)
            query = query.Where(c => c.IdPaciente == filtroPaciente.Value);

        if (!string.IsNullOrWhiteSpace(filtroEstado))
            query = query.Where(c => c.Estado == filtroEstado);

        if (filtroMes.HasValue)
            query = query.Where(c => c.FechaHora.Month == filtroMes.Value);

        citasFiltradas = query.OrderBy(c => c.FechaHora).ToList();
        StateHasChanged();
    }

    private void DiaAnterior() { fechaSeleccionada = fechaSeleccionada.AddDays(-1); FiltrarCitas(); }
    private void DiaSiguiente() { fechaSeleccionada = fechaSeleccionada.AddDays(1); FiltrarCitas(); }

    private void CambiarVista(VistaType t)
    {
        vistaDia = t == VistaType.Dia;
        vistaSemana = t == VistaType.Semana;
        vistaMes = t == VistaType.Mes;

        FiltrarCitas();
    }

    private void IrHoy() { fechaSeleccionada = DateTime.Today; FiltrarCitas(); }

    private void NuevaCita() => navManager.NavigateTo("/citas/agregar");

    private void OnFilterDoctorChange(ChangeEventArgs e)
    {
        filtroDoctor = int.TryParse(e.Value?.ToString(), out int id) ? id : null;
        FiltrarCitas();
    }

    private void OnFilterPacienteChange(ChangeEventArgs e)
    {
        filtroPaciente = int.TryParse(e.Value?.ToString(), out int id) ? id : null;
        FiltrarCitas();
    }

    private void OnFilterEstadoChange(ChangeEventArgs e)
    {
        filtroEstado = string.IsNullOrEmpty(e.Value?.ToString()) ? null : e.Value.ToString();
        FiltrarCitas();
    }

    private void OnFilterMesChange(ChangeEventArgs e)
    {
        filtroMes = int.TryParse(e.Value?.ToString(), out int mes) ? mes : null;
        FiltrarCitas();
    }

    private void OnFilterFechaChange(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out DateTime fecha))
        {
            fechaSeleccionada = fecha;
            vistaDia = true;
            vistaSemana = false;
            vistaMes = false;
        }
        FiltrarCitas();
    }

    private string GetNombrePaciente(int id)
    {
        var p = pacientes.FirstOrDefault(x => x.Id == id);
        return p == null ? "" : $"{p.Nombre} {p.Apellido}";
    }

    private string GetNombreDoctor(int? id)
    {
        var d = doctores.FirstOrDefault(x => x.Id == id);
        return d == null ? "" : $"{d.Nombre} {d.Apellido}";
    }
}
