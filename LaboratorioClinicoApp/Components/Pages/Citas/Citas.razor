@page "/citas"
@using LaboratorioClinicoApp.Services
@using LaboratorioClinicoApp.DTO
@inject CitaService citaService
@inject PacienteService pacienteService
@inject NavigationManager navManager

<link rel="stylesheet" href="/bootstrap/bootstrap.min.css" />
<link rel="stylesheet" href="/css/Cita/cita.css" />

<div class="citas-container">

    <header class="encabezado-sticky shadow-sm">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-outline-primary" @onclick="IrHoy">
                <i class="bi bi-calendar-event"></i> Hoy
            </button>
            <div class="text-center flex-grow-1">
                <div class="btn-group">
                    <button class="btn btn-outline-secondary @(vistaDia ? "active" : "")"
                            @onclick="() => CambiarVista(VistaType.Dia)">
                        Día
                    </button>
                    <button class="btn btn-outline-secondary @(vistaSemana ? "active" : "")"
                            @onclick="() => CambiarVista(VistaType.Semana)">
                        Semana
                    </button>
                    <button class="btn btn-outline-secondary @(vistaMes ? "active" : "")"
                            @onclick="() => CambiarVista(VistaType.Mes)">
                        Mes
                    </button>
                </div>
                <div class="mt-2 fw-bold fs-5">
                    @fechaSeleccionada.ToString("dddd, dd 'de' MMMM yyyy")
                </div>
                <div class="mt-1">
                    <button class="btn btn-sm btn-light me-2" @onclick="DiaAnterior">◀</button>
                    <button class="btn btn-sm btn-light" @onclick="DiaSiguiente">▶</button>
                </div>
            </div>
            <button class="btn btn-outline-dark">
                <i class="bi bi-person-circle"></i>
            </button>
        </div>

        <!-- TABS -->
        <div class="tab-menu">
            <div class="tab-item @(EsConsultas ? "active" : "")"
                 @onclick="@(() => navManager.NavigateTo("/citas"))">
                Citas de Exámenes
            </div>

            <div class="tab-item @(EsExamenes ? "active" : "")"
                 @onclick="@(() => navManager.NavigateTo("/consulta"))">
                Consultas Médicas
            </div>
        </div>

        <div class="card shadow-sm p-3 filtros-card">
            <div class="row g-3 align-items-end">
                <div class="col-12 col-md-4">
                    <label class="form-label">Paciente</label>
                    <input list="listaPacientes" class="form-control" placeholder="Buscar paciente..."
                           @bind="TextoBusquedaPaciente" @bind:event="oninput" />
                    <datalist id="listaPacientes">
                        @foreach (var p in pacientes)
                        {
                            <option value="@($"{p.Nombre} {p.Apellido}")"></option>
                        }
                    </datalist>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Mes</label>
                    <select class="form-select" @bind="FiltroMes">
                        <option value="">Todos</option>
                        @for (int m = 1; m <= 12; m++)
                        {
                            <option value="@m">@((new DateTime(2000, m, 1)).ToString("MMMM"))</option>
                        }
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Fecha</label>
                    <input type="date" class="form-control" @bind="FechaFiltro" />
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Estado</label>
                    <select class="form-select" @bind="FiltroEstado">
                        <option value="">Todos</option>
                        @foreach (var estado in estadosDisponibles)
                        {
                            <option value="@estado">@estado</option>
                        }
                    </select>
                </div>
                <div class="col-6 col-md-2 d-flex align-items-end">
                    <button class="btn btn-success w-100" @onclick="NuevaCita">
                        <i class="bi bi-plus-lg"></i> Nueva Cita
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="contenido-scroll">
        @if (isLoading)
        {
            <div class="text-center fs-5 py-5">Cargando citas...</div>
        }
        else if (citasFiltradas == null || citasFiltradas.Count == 0)
        {
            <div class="alert alert-info text-center mt-3">No hay citas con estos filtros.</div>
        }
        else
        {
            <div class="row g-3 mt-2">
                @foreach (var cita in citasFiltradas)
                {
                    <div class="cita-card shadow-sm p-3 rounded-3">
                        <div class="row align-items-center">

                            <div class="col-3 text-center">
                                <div class="hora fw-bold">@cita.FechaHora.ToString("hh:mm tt")</div>
                                <div class="fecha text-muted">@cita.FechaHora.ToString("dd/MM/yyyy")</div>
                            </div>

                            <div class="col-6">
                                <div class="titulo-examen fw-semibold">@cita.Motivo</div>
                                <div class="paciente text-muted fw-bold">@cita.PacienteNombre</div>

                                @if (!string.IsNullOrEmpty(cita.NotasConsulta))
                                {
                                    <div class="detalle text-secondary small">
                                        Notas: @cita.NotasConsulta
                                    </div>
                                }
                            </div>

                            <div class="col-2 text-center">
                                <span class="estado-pill @GetEstadoClase(cita.Estado)"
                                      @onclick="@(() => AbrirSelectorEstado(cita))">
                                    @cita.Estado
                                </span>
                            </div>

                            <div class="col-1 text-center d-flex flex-row align-items-center justify-content-center">

                                <button class="btn btn-primary btn-sm"
                                        @onclick="@(() => EditarCita(cita.Id))"
                                        title="Editar Cita">
                                    Editar
                                </button>
 
                            </div>

                        </div>
                    </div>
                }
            </div>
        }
    </main>
</div>

@if (mostrarSelectorEstado && citaSeleccionadaParaEstado != null)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1" role="dialog" style="padding-right: 17px;">
        <div class="modal-dialog modal-sm" role="document">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Actualizar Estado</h5>
                    <button type="button" class="btn-close" @onclick="CerrarSelectorEstado"></button>
                </div>

                <div class="modal-body">
                    <p class="mb-2">¿Desea cambiar el estado de la cita?</p>
                    <p class="fw-bold">Paciente: <span class="text-primary">@citaSeleccionadaParaEstado.PacienteNombre</span></p>

                    <div class="mb-3">
                        <label for="selectEstado" class="form-label fw-bold">Nuevo Estado</label>

                        <select id="selectEstado" class="form-select" @bind="nuevoEstadoSeleccionado">
                            @foreach (var estado in estadosDisponibles)
                            {
                                <option value="@estado">@estado</option>
                            }
                        </select>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarSelectorEstado">No (Cancelar)</button>
                    <button type="button" class="btn btn-primary" @onclick="GuardarNuevoEstado">Sí (Guardar)</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<CitaDTO> citas = new();
    private List<CitaDTO> citasFiltradas = new();
    private List<PacienteDTO> pacientes = new();

    private bool EsConsultas => navManager.Uri.Contains("/citas");
    private bool EsExamenes => navManager.Uri.Contains("/consulta") &&
                               !navManager.Uri.Contains("/citas/editar/") &&
                               !navManager.Uri.Contains("/citas/agregar");

    private bool isLoading = true;
    private DateTime fechaSeleccionada = DateTime.Today;

    private bool vistaDia = true, vistaSemana = false, vistaMes = false;
    enum VistaType { Dia, Semana, Mes }

    // --- Variables para el manejo del estado ---
    private bool mostrarSelectorEstado = false;
    private CitaDTO? citaSeleccionadaParaEstado = null;
    private string nuevoEstadoSeleccionado = "";

    // Lista de estados para el filtro y el selector
    private readonly List<string> estadosDisponibles = new List<string> { "Activo", "Inactivo", "Cancelado", "Completado" };

    // --- Variables de Filtro ---
    private string _textoBusquedaPaciente = "";
    private string TextoBusquedaPaciente
    {
        get => _textoBusquedaPaciente;
        set { _textoBusquedaPaciente = value; FiltrarCitas(); }
    }
    private string? _filtroEstado;
    private string? FiltroEstado
    {
        get => _filtroEstado;
        set { _filtroEstado = value; FiltrarCitas(); }
    }
    private int? _filtroMes;
    private int? FiltroMes
    {
        get => _filtroMes;
        set { _filtroMes = value; FiltrarCitas(); }
    }
    private DateTime? _fechaFiltro;
    private DateTime? FechaFiltro
    {
        get => _fechaFiltro;
        set { _fechaFiltro = value; FiltrarCitas(); }
    }

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;

        var todas = await citaService.GetCitas();

        pacientes = await pacienteService.GetPacientes();

        // Solo tipo EXAMEN
        citas = todas
            .Where(c => !string.IsNullOrWhiteSpace(c.TipoCita) &&
                        c.TipoCita.Equals("EXAMEN", StringComparison.OrdinalIgnoreCase))
            .ToList();

        // Asignar nombre del paciente
        foreach (var c in citas)
        {
            var p = pacientes.FirstOrDefault(x => x.Id == c.IdPaciente);
            if (p != null)
            {
                c.PacienteNombre = $"{p.Nombre} {p.Apellido}";
            }
        }

        FiltrarCitas();
        isLoading = false;
    }


    private void FiltrarCitas()
    {
        var query = citas.AsQueryable();
        // Lógica de Filtrado por vista de fecha
        if (FechaFiltro.HasValue)
        {
            query = query.Where(c => c.FechaHora.Date == FechaFiltro.Value.Date);
        }
        else if (vistaDia)
        {
            query = query.Where(c => c.FechaHora.Date == fechaSeleccionada.Date);
        }
        else if (vistaSemana)
        {
            var day = (int)fechaSeleccionada.DayOfWeek;
            var startOfWeek = fechaSeleccionada.Date.AddDays(-(day == 0 ? 6 : day - 1));
            var endOfWeek = startOfWeek.AddDays(7);
            query = query.Where(c => c.FechaHora >= startOfWeek && c.FechaHora < endOfWeek);
        }
        else if (vistaMes)
        {
            var mes = FiltroMes ?? fechaSeleccionada.Month;
            var year = fechaSeleccionada.Year;
            query = query.Where(c => c.FechaHora.Month == mes && c.FechaHora.Year == year);
        }

        // Lógica de Filtrado por paciente
        if (!string.IsNullOrWhiteSpace(TextoBusquedaPaciente))
        {
            var buscar = TextoBusquedaPaciente.Trim().ToLowerInvariant();
            var ids = pacientes
                .Where(p => $"{p.Nombre} {p.Apellido}".ToLowerInvariant().Contains(buscar))
                .Select(p => p.Id)
                .ToList();

            if (ids.Any())
                query = query.Where(c => ids.Contains(c.IdPaciente));
            else
                query = query.Where(c => false);
        }

        // Lógica de Filtrado por estado y mes
        if (!string.IsNullOrEmpty(FiltroEstado))
            query = query.Where(c => c.Estado == FiltroEstado);

        if (FiltroMes.HasValue && !vistaMes)
        {
            query = query.Where(c => c.FechaHora.Month == FiltroMes);
        }

        citasFiltradas = query.OrderBy(c => c.FechaHora).ToList();
        StateHasChanged();
    }

    private void DiaAnterior()
    {
        if (vistaDia || FechaFiltro.HasValue)
        {
            fechaSeleccionada = fechaSeleccionada.AddDays(-1);
        }
        else if (vistaSemana)
        {
            fechaSeleccionada = fechaSeleccionada.AddDays(-7);
        }
        else if (vistaMes)
        {
            fechaSeleccionada = fechaSeleccionada.AddMonths(-1);
        }
        FiltrarCitas();
    }

    private void DiaSiguiente()
    {
        if (vistaDia || FechaFiltro.HasValue)
        {
            fechaSeleccionada = fechaSeleccionada.AddDays(1);
        }
        else if (vistaSemana)
        {
            fechaSeleccionada = fechaSeleccionada.AddDays(7);
        }
        else if (vistaMes)
        {
            fechaSeleccionada = fechaSeleccionada.AddMonths(1);
        }
        FiltrarCitas();
    }

    private void IrHoy()
    {
        fechaSeleccionada = DateTime.Today;
        FechaFiltro = null;
        FiltrarCitas();
    }

    private void CambiarVista(VistaType tipo)
    {
        vistaDia = tipo == VistaType.Dia;
        vistaSemana = tipo == VistaType.Semana;
        vistaMes = tipo == VistaType.Mes;
        FechaFiltro = null;
        FiltroMes = null;

        FiltrarCitas();
    }

    private void NuevaCita() => navManager.NavigateTo("/citas/agregar");
    void EditarCita(int id) => navManager.NavigateTo($"/citas/editar/{id}");


    private string GetEstadoClase(string estado) =>
        estado switch
        {
            "Activo" => "estado-activo",
            "Cancelado" => "estado-cancelado",
            "Completado" => "estado-completado",
            _ => "estado-default"
        };

    // -----------------------------------------------------
    // FUNCIONALIDAD DE CAMBIO DE ESTADO
    // -----------------------------------------------------

    private async Task AbrirSelectorEstado(CitaDTO cita)
    {
        citaSeleccionadaParaEstado = cita;
        nuevoEstadoSeleccionado = cita.Estado;
        mostrarSelectorEstado = true;
    }

    private void CerrarSelectorEstado()
    {
        mostrarSelectorEstado = false;
        citaSeleccionadaParaEstado = null;
        nuevoEstadoSeleccionado = "";
    }

    private async Task GuardarNuevoEstado()
    {
        if (citaSeleccionadaParaEstado != null && !string.IsNullOrWhiteSpace(nuevoEstadoSeleccionado))
        {
            citaSeleccionadaParaEstado.Estado = nuevoEstadoSeleccionado;
            await citaService.UpdateCita(citaSeleccionadaParaEstado.Id, citaSeleccionadaParaEstado);
            await OnInitializedAsync();
            CerrarSelectorEstado();
        }
    }
}